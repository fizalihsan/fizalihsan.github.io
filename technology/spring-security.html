
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spring Security - KnowledgeShop</title>
  <meta name="author" content="Mohamed Fizal Ihsan Mohamed">


<meta name="description" content="Spring Security Introduction Overriding the UserDetailsService component Overriding the endpoint authorization configuration Overriding the &hellip;">
<meta name="keywords" content="big data, data science, mongodb, nosql, R, statistics">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://fizalihsan.github.io/technology/spring-security.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!-- Below custom CSS is for table border styling -->
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  <link href="" rel="alternate" title="KnowledgeShop" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
jax: ["input/TeX", "output/HTML-CSS"],
tex2jax: {
  inlineMath: [ ['$', '$'], ["\\(","\\)"] ],
  displayMath: [ ['$$', '$$'], ["\\[","\\]"] ],
  processEscapes: true,
  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
},
messageStyle: "none",
"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript" /></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-58187831-1']);
    _gaq.push(['_setDomainName','github.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KnowledgeShop</a></h1>
  
    <h2>Learn & Share</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:fizalihsan.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  


<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Spring Security</h1>
    
  </header>
  
  <ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a>    <ul>
      <li><a href="#overriding-the-userdetailsservice-component" id="markdown-toc-overriding-the-userdetailsservice-component">Overriding the UserDetailsService component</a></li>
      <li><a href="#overriding-the-endpoint-authorization-configuration" id="markdown-toc-overriding-the-endpoint-authorization-configuration">Overriding the endpoint authorization configuration</a></li>
      <li><a href="#overriding-the-authenticationprovider-implementation" id="markdown-toc-overriding-the-authenticationprovider-implementation">Overriding the AuthenticationProvider implementation</a></li>
    </ul>
  </li>
  <li><a href="#managing-users" id="markdown-toc-managing-users">Managing Users</a>    <ul>
      <li><a href="#implementing-authentication-in-spring-security" id="markdown-toc-implementing-authentication-in-spring-security">Implementing authentication in Spring Security</a></li>
      <li><a href="#describing-the-user" id="markdown-toc-describing-the-user">Describing the user</a></li>
      <li><a href="#detailing-on-the-grantedauthority-contract" id="markdown-toc-detailing-on-the-grantedauthority-contract">Detailing on the GrantedAuthority contract</a></li>
      <li><a href="#using-a-builder-to-create-instances-of-the-userdetails-type" id="markdown-toc-using-a-builder-to-create-instances-of-the-userdetails-type">Using a builder to create instances of the UserDetails type</a></li>
      <li><a href="#understanding-the-userdetailsservice-contract" id="markdown-toc-understanding-the-userdetailsservice-contract">Understanding the UserDetailsService contract</a></li>
      <li><a href="#implementing-the-userdetailsmanager-contract" id="markdown-toc-implementing-the-userdetailsmanager-contract">Implementing the UserDetailsManager contract</a></li>
    </ul>
  </li>
  <li><a href="#dealing-with-passwords" id="markdown-toc-dealing-with-passwords">Dealing with Passwords</a>    <ul>
      <li><a href="#understanding-the-passwordencoder-contract" id="markdown-toc-understanding-the-passwordencoder-contract">Understanding the PasswordEncoder contract</a></li>
    </ul>
  </li>
  <li><a href="#implementing-authentication" id="markdown-toc-implementing-authentication">Implementing authentication</a>    <ul>
      <li><a href="#using-the-securitycontext" id="markdown-toc-using-the-securitycontext">Using the SecurityContext</a>        <ul>
          <li><a href="#using-a-holding-strategy-for-the-security-context" id="markdown-toc-using-a-holding-strategy-for-the-security-context">Using a holding strategy for the security context</a></li>
          <li><a href="#using-a-holding-strategy-for-asynchronous-calls" id="markdown-toc-using-a-holding-strategy-for-asynchronous-calls">Using a holding strategy for asynchronous calls</a></li>
          <li><a href="#using-a-holding-strategy-for-standalone-applications" id="markdown-toc-using-a-holding-strategy-for-standalone-applications">Using a holding strategy for standalone applications</a></li>
          <li><a href="#forwarding-the-security-context-with-delegatingsecuritycontextrunnable" id="markdown-toc-forwarding-the-security-context-with-delegatingsecuritycontextrunnable">Forwarding the security context with DelegatingSecurityContextRunnable</a></li>
          <li><a href="#forwarding-the-security-context-with-delegatingsecuritycontextexecutorservice" id="markdown-toc-forwarding-the-security-context-with-delegatingsecuritycontextexecutorservice">Forwarding the security context with DelegatingSecurityContextExecutorService</a></li>
          <li><a href="#using-and-configuring-http-basic" id="markdown-toc-using-and-configuring-http-basic">Using and configuring HTTP Basic</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#references" id="markdown-toc-references">References</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p><img src="/technology/spring-security-1.png" /></p>

<p><strong>First Intro Project</strong></p>

<ul>
  <li>Spring Boot scans for components only in the package (and its subpackages) that contains the class annotated with <code>@SpringBootApplication</code>. If you annotate classes with any of the stereotype components in Spring outside of the main package, you must explicitly declare the location using the <code>@ComponentScan</code> annotation.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Maven configuration</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">   <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">   <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">   <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">   <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Web service endpoint</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@RestController</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&quot;Hello!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<ul>
  <li>When you run the app, and access the endpoint <code>curl http://localhost:8080/hello</code>, you get the below error</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="json"><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">401</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="s2">&quot;/hello&quot;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>By default, Spring Security expects the default username (<code>user</code>). Each time you run the application, it generates a new password and prints this password in the console.</li>
  <li>It works once the generated password is passed in as input</li>
</ul>

<blockquote>
  <p>With cURL, you can set the HTTP basic username and password with the <code>-u</code> flag. Behind the scenes, cURL encodes the string <code>&lt;username&gt;:&lt;password&gt;</code> in Base64 and sends it as the value of the Authorization header prefixed with the string Basic. And with cURL, it’s probably easier for you to use the <code>-u</code> flag. But it’s also essential to know what the real request looks like. So, let’s give it a try and manually create the Authorization header.</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c"># plain-text password</span>
</span><span class="line">curl -u user:93a01cf0-794b-4b98-86ef-54860f36f7f3 http://localhost:8080/hello
</span><span class="line">
</span><span class="line">OR
</span><span class="line">
</span><span class="line"><span class="c"># base-64 encoded</span>
</span><span class="line"><span class="nb">echo</span> -n user:93a01cf0-794b-4b98-86ef-54860f36f7f3 <span class="p">|</span> base64
</span><span class="line">curl -H <span class="s2">&quot;Authorization: Basic dXNlcjo5M2EwMWNmMC03OTRiLTRiOTgtODZlZi01NDg2MGYzNmY3ZjM=&quot;</span> localhost:8080/hello
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>High-level overview</strong></p>

<ul>
  <li>
    <p>The main components acting in the authentication process for Spring Security and the relationships among these. This architecture represents the backbone of implementing authentication with Spring Security. 
## Authentication process</p>
  </li>
  <li>Steps
    <ul>
      <li>The authentication filter delegates the authentication request to the authentication manager and, based on the response, configures the security context.</li>
      <li>The authentication manager uses the authentication provider to process authentication.</li>
      <li>The authentication provider implements the authentication logic.</li>
      <li>The user details service implements user management responsibility, which the authentication provider uses in the authentication logic.</li>
      <li>The password encoder implements password management, which the authentication provider uses in the authentication logic.</li>
      <li>The security context keeps the authentication data after the authentication process.</li>
      <li>An object that implements a <code>UserDetailsService</code> contract with Spring Security manages the details about users.</li>
    </ul>
  </li>
  <li><strong>PasswordEncoder</strong>
    <ul>
      <li>The <code>PasswordEncoder</code> does two things:
        <ul>
          <li>Encodes a password</li>
          <li>Verifies if the password matches an existing encoding</li>
        </ul>
      </li>
      <li>the <code>PasswordEncoder</code> is mandatory for the Basic authentication flow</li>
      <li>a <code>PasswordEncoder</code> exists together with the default <code>UserDetailsService</code>. When we replace the default implementation of the UserDetailsService, we must also specify a <code>PasswordEncoder</code></li>
    </ul>
  </li>
  <li><strong>AuthenticationProvider</strong>
    <ul>
      <li>The <code>AuthenticationProvider</code> defines the authentication logic, delegating the user and password management. A default implementation of the <code>AuthenticationProvider</code> uses the default implementations provided for the <code>UserDetailsService</code> and the <code>PasswordEncoder</code>. Implicitly, your application secures all the endpoints.</li>
    </ul>
  </li>
  <li><strong>Override default configurations</strong>
    <ul>
      <li>In some cases, developers choose to use beans in the Spring context for the configuration. In other cases, they override various methods for the same purpose.</li>
      <li>Configuring a project with a mix of styles is not desirable as it makes the code difficult to understand and affects the maintainability of the application.</li>
    </ul>
  </li>
</ul>

<h2 id="overriding-the-userdetailsservice-component">Overriding the UserDetailsService component</h2>

<ul>
  <li>The application now uses the instance of type UserDetailsService you added to the context instead of the default autoconfigured one. But, at the same time, you won’t be able to access the endpoint anymore for two reasons:
    <ul>
      <li>You don’t have any users.</li>
      <li>You don’t have a <code>PasswordEncoder</code>.</li>
    </ul>
  </li>
  <li>When building the instance, we have to provide the username, the password, and at least one authority. The <strong>authority</strong> is an action allowed for that user, and we can use any string for this.</li>
  <li>Because we overrode <code>UserDetailsService</code>, we also have to declare a <code>PasswordEncoder</code>. Trying the example now, you’ll see an exception when you call the endpoint. When trying to do the authentication, Spring Security realizes it doesn’t know how to manage the password and fails.</li>
  <li>The <code>NoOpPasswordEncoder</code> instance treats passwords as plain text. It doesn’t encrypt or hash them. For matching, <code>NoOpPasswordEncoder</code> only compares the strings using the underlying <code>equals(Object o)</code> method of the String class.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Bean</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">UserDetailsService</span> <span class="nf">userDetailsService</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">var</span> <span class="n">userDetailsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">InMemoryUserDetailsManager</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">var</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;read&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">userDetailsService</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">userDetailsService</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Bean</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="overriding-the-endpoint-authorization-configuration">Overriding the endpoint authorization configuration</h2>

<ul>
  <li>With default configuration, all the endpoints assume you have a valid user managed by the application. Also, by default, your app uses HTTP Basic authentication as the authorization method.</li>
  <li>Not all endpoints of an application need to be secured, and for those that do, we might need to choose different authorization rules. To make such changes, we start by extending the <code>WebSecurityConfigurerAdapter</code> class. Extending this class allows us to override the <code>configure(HttpSecurity http)</code>.</li>
  <li>The <code>permitAll()</code> call in the configuration, together with the <code>anyRequest()</code> method, makes all the endpoints accessible without the need for credentials:</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Omitted code</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">();</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">           <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="overriding-the-authenticationprovider-implementation">Overriding the AuthenticationProvider implementation</h2>

<ul>
  <li>Below example shows the <code>AuthenticationProvider</code>, which implements the authentication logic and delegates to the <code>UserDetailsService</code> and <code>PasswordEncoder</code> for user and password management. So we could say that with this section, we go one step deeper in the authentication and authorization architecture to learn how to implement custom authentication logic with <code>AuthenticationProvider</code></li>
  <li>I recommend that you respect the responsibilities as designed in the Spring Security architecture. This architecture is loosely coupled with fine-grained responsibilities. That design is one of the things that makes Spring Security flexible and easy to integrate in your applications. But depending on how you make use of its flexibility, you could change the design as well. You have to be careful with these approaches as they can complicate your solution. For example, you could choose to override the default <code>AuthenticationProvider</code> in a way in which you no longer need a <code>UserDetailsService</code> or <code>PasswordEncoder</code>.</li>
</ul>

<p><img src="/technology/spring-security-2.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticationProvider</span> <span class="kd">implements</span> <span class="n">AuthenticationProvider</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">authenticate</span> <span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// authentication logic here</span>
</span><span class="line">    <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">());</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">username</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;12345&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">password</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">        <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">());</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="k">throw</span> <span class="k">new</span> <span class="nf">AuthenticationCredentialsNotFoundException</span> <span class="o">(</span><span class="s">&quot;Error in authentication!&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authenticationType</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// type of the Authentication implementation here</span>
</span><span class="line">    <span class="k">return</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">authenticationType</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Autowired</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">CustomAuthenticationProvider</span> <span class="n">authenticationProvider</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">auth</span><span class="o">.</span><span class="na">authenticationProvider</span><span class="o">(</span><span class="n">authenticationProvider</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="o">...</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><strong>Using multiple configuration classes in your project</strong>
    <ul>
      <li>good practice to separate the responsibilities even for the configuration classes. We need this separation because the configuration starts to become more complex.</li>
      <li>You can’t have both classes extending <code>WebSecurityConfigurerAdapter</code> in this case. If you do so, the dependency injection fails. You might solve the dependency injection by setting the priority for injection using the <code>@Order</code> annotation. But, functionally, this won’t work, as the configurations exclude each other instead of merging.</li>
    </ul>
  </li>
</ul>

<h1 id="managing-users">Managing Users</h1>

<ul>
  <li>Classes
    <ul>
      <li><code>UserDetails</code> - which describes the user for Spring Security.</li>
      <li><code>GrantedAuthority</code> - which allows us to define actions that the user can execute.</li>
      <li><code>UserDetailsManager</code> - which extends the <code>UserDetailsService</code> contract. Beyond the inherited behavior, it also describes actions like creating a user and modifying or deleting a user’s password.</li>
    </ul>
  </li>
</ul>

<h2 id="implementing-authentication-in-spring-security">Implementing authentication in Spring Security</h2>

<p><img src="/technology/spring-security-3.png" /></p>

<ul>
  <li>The <code>UserDetailsService</code> is only responsible for retrieving the user by username. This action is the only one needed by the framework to complete authentication.</li>
  <li>The <code>UserDetailsManager</code> adds behavior that refers to adding, modifying, or deleting the user, which is a required functionality in most applications. The separation between the two contracts is an excellent example of the interface segregation principle. Separating the interfaces allows for better flexibility because the framework doesn’t force you to implement behavior if your app doesn’t need it. If the app only needs to authenticate the users, then implementing the UserDetailsService contract is enough to cover the desired functionality.</li>
</ul>

<p><img src="/technology/spring-security-4.png" /></p>

<ul>
  <li>Dependencies between the components involved in user management. The <code>UserDetailsService</code> returns the details of a user, finding the user by its name. The <code>UserDetails</code> contract describes the user. A user has one or more authorities, represented by the <code>GrantedAuthority</code> interface. To add operations such as create, delete, or change password to the user, the <code>UserDetailsManager</code> contract extends <code>UserDetailsService</code> to add operations.</li>
</ul>

<h2 id="describing-the-user">Describing the user</h2>

<ul>
  <li>For Spring Security, a user definition should respect the <code>UserDetails</code> contract. The <code>UserDetails</code> contract represents the user as understood by Spring Security. The class of your application that describes the user has to implement this interface, and in this way, the framework understands it.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetails</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">getUsername</span><span class="o">();</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">getPassword</span><span class="o">();</span>
</span><span class="line">  <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>Spring Security uses authorities to refer either to fine-grained privileges or to roles, which are groups of privileges.</li>
</ul>

<h2 id="detailing-on-the-grantedauthority-contract">Detailing on the GrantedAuthority contract</h2>

<ul>
  <li>the actions granted for a user are called <em>authorities</em>.</li>
  <li>The authorities represent what the user can do in your application. Without authorities, all users would be equal.</li>
  <li>To create an authority, you only need to find a name for that privilege so you can refer to it later when writing the authorization rules.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GrantedAuthority</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="nf">getAuthority</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>The <code>SimpleGrantedAuthority</code> class offers a way to create immutable instances of the type GrantedAuthority.
    <ul>
      <li><code>GrantedAuthority g1 = () -&gt; "READ";</code></li>
      <li><code>GrantedAuthority g2 = new SimpleGrantedAuthority("READ");</code></li>
    </ul>
  </li>
</ul>

<h2 id="using-a-builder-to-create-instances-of-the-userdetails-type">Using a builder to create instances of the UserDetails type</h2>

<p>The <code>User</code> class from the <code>org.springframework.security.core.userdetails</code> package is a simple way to build instances of the <code>UserDetails</code> type. Using this class, you can create immutable instances of <code>UserDetails</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">UserDetails</span> <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;bill&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;read&quot;</span><span class="o">,</span> <span class="s">&quot;write&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">accountExpired</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">disabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="understanding-the-userdetailsservice-contract">Understanding the UserDetailsService contract</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>
</span><span class="line">  <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The authentication implementation calls the <code>loadUserByUsername(String username)</code> method to obtain the details of a user with a given username . The <code>username</code> is, of course, considered unique. The user returned by this method is an implementation of the <code>UserDetails</code> contract. If the username doesn’t exist, the method throws a <code>UsernameNotFoundException</code>.</p>

<p>The <code>AuthenticationProvider</code> is the component that implements the authentication logic and uses the <code>UserDetailsService</code> to load details about the user. To find the user by username, it calls the <code>loadUserByUsername(String username)</code> method.</p>

<p><img src="/technology/spring-security-5.png" /></p>

<h2 id="implementing-the-userdetailsmanager-contract">Implementing the UserDetailsManager contract</h2>

<p>The Spring Security authentication flow. Here we use a <code>JDBCUserDetailsManager</code> as our <code>UserDetailsService</code> component. The <code>JdbcUserDetailsManager</code> uses a database to manage users.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsManager</span> <span class="kd">extends</span> <span class="n">UserDetailsService</span> <span class="o">{</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">createUser</span><span class="o">(</span><span class="n">UserDetails</span> <span class="n">user</span><span class="o">);</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">UserDetails</span> <span class="n">user</span><span class="o">);</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">changePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">oldPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">newPassword</span><span class="o">);</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">userExists</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/technology/spring-security-6.png" /></p>

<h1 id="dealing-with-passwords">Dealing with Passwords</h1>

<h2 id="understanding-the-passwordencoder-contract">Understanding the PasswordEncoder contract</h2>

<p><img src="/technology/spring-security-7.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordEncoder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">String</span> <span class="nf">encode</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">);</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">encodedPassword</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">  <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">upgradeEncoding</span><span class="o">(</span><span class="n">String</span> <span class="n">encodedPassword</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sha512PasswordEncoder</span> <span class="kd">implements</span> <span class="n">PasswordEncoder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">encode</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nf">hashWithSHA512</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span>
</span><span class="line">    <span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">encodedPassword</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="n">hashedPassword</span> <span class="o">=</span> <span class="n">encode</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">encodedPassword</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">hashedPassword</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Omitted code</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Spring Security provides the following encoders out-of-the-box:</p>

<ul>
  <li><code>NoOpPasswordEncoder</code>–Doesn’t encode the password but keeps it in cleartext. We use this implementation only for examples. Because it doesn’t hash the password, you should never use it in a real-world scenario.</li>
  <li><code>StandardPasswordEncoder</code>–Uses SHA-256 to hash the password. This implementation is now deprecated, and you shouldn’t use it for your new implementations. The reason why it’s deprecated is that it uses a hashing algorithm that we don’t consider strong enough anymore, but you might still find this implementation used in existing applications.</li>
  <li><code>Pbkdf2PasswordEncoder</code>–Uses the password-based key derivation function 2 (PBKDF2).</li>
  <li><code>BCryptPasswordEncoder</code>–Uses a bcrypt strong hashing function to encode the password.</li>
  <li><code>SCryptPasswordEncoder</code>–Uses an scrypt hashing function to encode the password.</li>
</ul>

<h1 id="implementing-authentication">Implementing authentication</h1>

<p>The authentication process, which has only two possible results:</p>

<ol>
  <li>The entity making the request is not authenticated. The user is not recognized, and the application rejects the request without delegating to the authorization process. Usually, in this case, the response status sent back to the client is <em>HTTP 401 Unauthorized</em>.</li>
  <li>The entity making the request is authenticated. The details about the requester are stored such that the application can use these for authorization. The <code>SecurityContext</code> interface is the instance that stores the details about the current authenticated request.</li>
</ol>

<p><img src="/technology/spring-security-8.png" /></p>

<p>The <code>Authentication</code> interface represents the authentication request event and holds the details of the entity that requests access to the application. You can use the information related to the authentication request event during and after the authentication process. The user requesting access to the application is called a <em>principal</em>. If you’ve ever used the Java Security API in any app, you learned that in the Java Security API, an interface named <code>Principal</code> represents the same concept.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Authentication</span> <span class="kd">extends</span> <span class="n">Principal</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>
</span><span class="line">  <span class="n">Object</span> <span class="nf">getCredentials</span><span class="o">();</span>
</span><span class="line">  <span class="n">Object</span> <span class="nf">getDetails</span><span class="o">();</span>
</span><span class="line">  <span class="n">Object</span> <span class="nf">getPrincipal</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isAuthenticated</span><span class="o">();</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">setAuthenticated</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isAuthenticated</span><span class="o">)</span>
</span><span class="line">     <span class="kd">throws</span> <span class="n">IllegalArgumentException</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthenticationProvider</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authentication</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>AuthenticationProvider</code> responsibility is strongly coupled with the <code>Authentication</code> contract. The <code>authenticate()</code> method receives an <code>Authentication</code> object as a parameter and returns an <code>Authentication</code> object. We implement the <code>authenticate()</code> method to define the authentication logic.</p>

<ul>
  <li>The method should throw an <code>AuthenticationException</code> if the authentication fails.</li>
  <li>If the method receives an authentication object that is not supported by your implementation of <code>AuthenticationProvider</code>, then the method should return <code>null</code>. This way, we have the possibility of using multiple <code>Authentication</code> types separated at the HTTP-filter level.</li>
  <li>The method should return an <code>Authentication</code> instance representing a fully authenticated object. For this instance, the <code>isAuthenticated()</code> method returns true, and it contains all the necessary details about the authenticated entity. Usually, the application also removes sensitive data like a password from this instance. After implementation, the password is no longer required and keeping these details can potentially expose them to unwanted eyes.</li>
</ul>

<p>The second method in the <code>AuthenticationProvider</code> interface is <code>supports-(Class&lt;?&gt; authentication)</code>. You can implement this method to return true if the current <code>AuthenticationProvider</code> supports the type provided as an <code>Authentication</code> object. Observe that even if this method returns true for an object, there is still a chance that the <code>authenticate()</code> method rejects the request by returning null. Spring Security is designed like this to be more flexible and to allow you to implement an <code>AuthenticationProvider</code> that can reject an authentication request based on the request’s details, not only by its type.</p>

<p><img src="/technology/spring-security-9.png" /></p>

<p><code>AuthenticationManager</code> delegates to one of the available authentication providers. The <code>AuthenticationProvider</code> might not support the provided type of authentication. On the other hand, if it does support the object type, it might not know how to authenticate that specific object. The authentication is evaluated, and an <code>AuthenticationProvider</code> that can say if the request is correct or not responds to the <code>AuthenticationManager</code>.</p>

<p><img src="/technology/spring-security-10.png" /></p>

<p>If the user doesn’t exist, the <code>loadUserByUsername()</code> method should throw an <code>AuthenticationException</code>. In this case, the authentication process stops, and the HTTP filter sets the response status to HTTP 401 Unauthorized. If the username exists, we can check further the user’s password with the matches() method of the PasswordEncoder from the context. If the password does not match, then again, an <code>AuthenticationException</code> should be thrown. If the password is correct, the <code>AuthenticationProvider</code> returns an instance of <code>Authentication</code> marked as “authenticated,” which contains the details about the request.</p>

<p>To plug in the new implementation of the <code>AuthenticationProvider</code>, override the <code>configure(AuthenticationManagerBuilder auth)</code> method of the <code>WebSecurityConfigurerAdapter</code> class in the configuration class of the project.</p>

<p>Using the <code>@Autowired</code> annotation over a field declared as an <code>AuthenticationProvider</code>. Spring recognizes the <code>AuthenticationProvider</code> as an interface (which is an abstraction). But Spring knows that it needs to find in its context an instance of an implementation for that specific interface. In our case, the implementation is the instance of <code>CustomAuthenticationProvider</code>, which is the only one of this type that we declared and added to the Spring context using the <code>@Component</code> annotation.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Autowired</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">AuthenticationProvider</span> <span class="n">authenticationProvider</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">auth</span><span class="o">.</span><span class="na">authenticationProvider</span><span class="o">(</span><span class="n">authenticationProvider</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Omitted code</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="using-the-securitycontext">Using the SecurityContext</h2>

<p>It is likely that you will need details about the authenticated entity after the authentication process ends. You might, for example, need to refer to the username or the authorities of the currently authenticated user. Is this information still accessible after the authentication process finishes?</p>

<p>Once the <code>AuthenticationManager</code> completes the authentication process successfully, it stores the <code>Authentication</code> instance for the rest of the request. The instance storing the <code>Authentication</code> object is called the <em>security context</em>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SecurityContext</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Authentication</span> <span class="nf">getAuthentication</span><span class="o">();</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">setAuthentication</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After successful authentication, the authentication filter stores the details of the authenticated entity in the security context. From there, the controller implementing the action mapped to the request can access these details when needed.</p>

<p>Spring Security offers three strategies to manage the <code>SecurityContext</code> with an object in the role of a manager. It’s named the <code>SecurityContextHolder</code>:</p>

<ol>
  <li><code>MODE_THREADLOCAL</code>–Allows each thread to store its own details in the security context. In a thread-per-request web application, this is a common approach as each request has an individual thread.</li>
  <li><code>MODE_INHERITABLETHREADLOCAL</code>–Similar to <code>MODE_THREADLOCAL</code> but also instructs Spring Security to copy the security context to the next thread in case of an asynchronous method. This way, we can say that the new thread running the @Async method inherits the security context.</li>
  <li><code>MODE_GLOBAL</code>–Makes all the threads of the application see the same security context instance.</li>
</ol>

<p><img src="/technology/spring-security-11.png" /></p>

<h3 id="using-a-holding-strategy-for-the-security-context">Using a holding strategy for the security context</h3>

<p>The first strategy for managing the security context is the <code>MODE_THREADLOCAL</code> strategy. This strategy is also the default for managing the security context used by Spring Security. With this strategy, Spring Security uses <code>ThreadLocal</code> to manage the context. This implementation works as a collection of data but makes sure that each thread of the application can see only the data stored in the collection. This way, each request has access to its security context. No thread will have access to another’s ThreadLocal. And that means that in a web application, each request can see only its own security context. We could say that this is also what you generally want to have for a backend web application.</p>

<p>Below figure offers an overview of this functionality. Each request (A, B, and C) has its own allocated thread (T1, T2, and T3). This way, each request only sees the details stored in their security context. But this also means that if a new thread is created (for example, when an asynchronous method is called), the new thread will have its own security context as well. The details from the parent thread (the original thread of the request) are not copied to the security context of the new thread.</p>

<blockquote>
  <p>This architecture only applies to the traditional servlet application where each request has its own thread assigned. It does not apply to <em>reactive</em> applications.</p>
</blockquote>

<p><img src="/technology/spring-security-12.png" /></p>

<p>Each request has its own thread, represented by an arrow. Each thread has access only to its own security context details. When a new thread is created (for example, by an <code>@Async</code> method), the details from the parent thread aren’t copied.</p>

<p>Being the default strategy for managing the security context, this process does not need to be explicitly configured. Just ask for the security context from the holder using the static <code>getContext()</code> method wherever you need it after the end of the authentication process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Obtaining the SecurityContext from the SecurityContextHolder</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">  <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">  <span class="n">Authentication</span> <span class="n">a</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="k">return</span> <span class="s">&quot;Hello, &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Obtaining the authentication from the context is even more comfortable at the endpoint level, as Spring knows to inject it directly into the method parameters. You don’t need to refer every time to the <code>SecurityContextHolder</code> class explicitly.</p>

<h3 id="using-a-holding-strategy-for-asynchronous-calls">Using a holding strategy for asynchronous calls</h3>

<p><img src="/technology/spring-security-13.png" /></p>

<p>The situation gets more complicated if we have to deal with multiple threads per request. Look at what happens if you make the endpoint asynchronous. The thread that executes the method is no longer the same thread that serves the request.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>An @Async method served by a different thread</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/bye&quot;</span><span class="o">)</span>
</span><span class="line"><span class="nd">@Async</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">goodbye</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">  <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">  <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// do something with the username</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>To enable the functionality of the @Async annotation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="nd">@EnableAsync</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you try the code as it is now, it throws a <code>NullPointerException</code> on the line that gets the name from the authentication, which is <code>String username = context.getAuthentication().getName()</code>.</p>

<p>This is because the method executes now on another thread that does not inherit the security context. For this reason, the <code>Authorization</code> object is null and, in the context of the presented code, causes a <code>NullPointerException</code>. In this case, you could solve the problem by using the <code>MODE_INHERITABLETHREADLOCAL</code> strategy. This can be set either by calling the <code>SecurityContextHolder.setStrategyName()</code> method or by using the system property <code>spring.security.strategy</code>. By setting this strategy, the framework knows to copy the details of the original thread of the request to the newly created thread of the asynchronous method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Using InitializingBean to set SecurityContextHolder mode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="nd">@EnableAsync</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Bean</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">InitializingBean</span> <span class="nf">initializingBean</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">setStrategyName</span><span class="o">(</span>
</span><span class="line">      <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">MODE_INHERITABLETHREADLOCAL</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<blockquote>
  <p>This works, however, only when the framework itself creates the thread (for example, in case of an <code>@Async</code> method). If your code creates the thread, you will run into the same problem even with the <code>MODE_INHERITABLETHREADLOCAL</code> strategy. This happens because, in this case, the framework does not know about the thread that your code creates.</p>
</blockquote>

<h3 id="using-a-holding-strategy-for-standalone-applications">Using a holding strategy for standalone applications</h3>

<p>If what you need is a security context shared by all the threads of the application, you change the strategy to <code>MODE_GLOBAL</code>.</p>

<p>With <code>MODE_GLOBAL</code> used as the security context management strategy, all the threads access the same security context. This implies that these all have access to the same data and can change that information. Because of this, race conditions can occur, and you have to take care of synchronization.</p>

<p>Be aware that the <code>SecurityContext</code> is not thread safe. So, with this strategy where all the threads of the application can access the <code>SecurityContext</code> object, you need to take care of concurrent access.</p>

<p><img src="/technology/spring-security-14.png" /></p>

<h3 id="forwarding-the-security-context-with-delegatingsecuritycontextrunnable">Forwarding the security context with DelegatingSecurityContextRunnable</h3>

<p>What happens when your code starts new threads without the framework knowing about them? Sometimes we name these self-managed threads because it is we who manage them, not the framework.</p>

<p>No specific strategy of the <code>SecurityContextHolder</code> offers you a solution to self-managed threads. In this case, you need to take care of the security context propagation. One solution for this is to use the <code>DelegatingSecurityContextRunnable</code> to decorate the tasks you want to execute on a separate thread. The <code>DelegatingSecurityContextRunnable</code> extends <code>Runnable</code>. You can use it following the execution of the task when there is no value expected. If you have a return value, then you can use the <code>Callable&lt;T&gt;</code> alternative, which is <code>DelegatingSecurityContextCallable&lt;T&gt;</code>. Both classes represent tasks executed asynchronously, as any other <code>Runnable</code> or <code>Callable</code>. Moreover, these make sure to copy the current security context for the thread that executes the task.</p>

<p><img src="/technology/spring-security-15.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Defining an ExecutorService and submitting the task</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">ciao</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">      <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">  <span class="o">};</span>
</span><span class="line">
</span><span class="line">  <span class="n">ExecutorService</span> <span class="n">e</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span><span class="line">  <span class="k">try</span> <span class="o">{</span>
</span><span class="line">     <span class="k">return</span> <span class="s">&quot;Ciao, &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">).</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">     <span class="n">e</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you run the application as is, you get nothing more than a <code>NullPointerException</code>. Inside the newly created thread to run the callable task, the authentication does not exist anymore, and the security context is empty. To solve this problem, we decorate the task with <code>DelegatingSecurityContextCallable</code>, which provides the current context to the new thread, as provided by this listing.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Running the task decorated by DelegatingSecurityContextCallable</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">ciao</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">  <span class="o">};</span>
</span><span class="line">
</span><span class="line">  <span class="n">ExecutorService</span> <span class="n">e</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span><span class="line">  <span class="k">try</span> <span class="o">{</span>
</span><span class="line">    <span class="n">var</span> <span class="n">contextTask</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DelegatingSecurityContextCallable</span><span class="o">&lt;&gt;(</span><span class="n">task</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&quot;Ciao, &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">contextTask</span><span class="o">).</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="forwarding-the-security-context-with-delegatingsecuritycontextexecutorservice">Forwarding the security context with DelegatingSecurityContextExecutorService</h3>

<ul>
  <li>But we have a second option to deal with the security context propagation to a new thread, and this is to manage propagation from the thread pool instead of from the task itself. An alternative to decorating tasks is to use a particular type of <code>Executor</code>.</li>
  <li>The propagation of the security context happens because an implementation called <code>DelegatingSecurityContextExecutorService</code> decorates the <code>ExecutorService</code>. It also takes care of the security context propagation.</li>
</ul>

<p><img src="/technology/spring-security-16.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Propagating the SecurityContext</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/hola&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">hola</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">  <span class="o">};</span>
</span><span class="line">
</span><span class="line">  <span class="n">ExecutorService</span> <span class="n">e</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span><span class="line">  <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DelegatingSecurityContextExecutorService</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class="line">  <span class="k">try</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&quot;Hola, &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">).</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="using-and-configuring-http-basic">Using and configuring HTTP Basic</h3>

<ul>
  <li>For example, you might want to implement a specific logic for the case in which the authentication process fails. You might even need to set some values on the response sent back to the client in this case.</li>
  <li>You can also call the <code>httpBasic()</code> method of the <code>HttpSecurity</code> instance with a parameter of type <code>Customizer</code>. This parameter allows you to set up some configurations related to the authentication method.</li>
  <li>Also, by using a <code>Customizer</code>, we can customize the response for a failed authentication. You need to do this if the client of your system expects something specific in the response in the case of a failed authentication. You might need to add or remove one or more headers. Or you can have some logic that filters the body to make sure that the application doesn’t expose any sensitive data to the client.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="n">c</span><span class="o">.</span><span class="na">realmName</span><span class="o">(</span><span class="s">&quot;OTHER&quot;</span><span class="o">);</span>
</span><span class="line">      <span class="n">c</span><span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="k">new</span> <span class="nf">CustomEntryPoint</span><span class="o">());</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>To customize the response for a failed authentication, we can implement an <code>AuthenticationEntryPoint</code>. Its <code>commence()</code> method receives the <code>HttpServletRequest</code>, the <code>HttpServletResponse</code>, and the <code>AuthenticationException</code> that cause the authentication to fail. Below listing demonstrates a way to implement the <code>AuthenticationEntryPoint</code>, which adds a header to the response and sets the HTTP status to 401 Unauthorized.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Implementing an AuthenticationEntryPoint</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomEntryPoint</span> <span class="kd">implements</span> <span class="n">AuthenticationEntryPoint</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commence</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span>
</span><span class="line">    <span class="n">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="n">AuthenticationException</span> <span class="n">e</span><span class="o">)</span>
</span><span class="line">      <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">      <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">,</span> <span class="s">&quot;Luke, I am your father!&quot;</span><span class="o">);</span>
</span><span class="line">      <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="references">References</h1>

<ul>
  <li>Book - Spring Security in Action (Manning publications)</li>
</ul>

  
    <footer>
      
      
        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://fizalihsan.github.io/technology/spring-security.html" data-via="fizalihsan" data-counturl="http://fizalihsan.github.io/technology/spring-security.html" >Tweet</a>
  
  
  
</div>

      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    <section>

	<br/><br/>
	<ul>
		<h2>Technical</h2>

		<li>
			<h3>Architecture</h3>
			<a href="/technology/architecture.html">Overview</a>  |  
			<a href="/technology/coding-principles.html">Coding Principles</a> |	
			<a href="/technology/ddd.html">DDD</a>  |  
			<a href="/technology/design-principles.html">Design Principles</a>  |
			<a href="/technology/eventsourcing.html">Event Sourcing</a> |  
			<a href="/technology/lambda-architecture.html">Lambda Architecture</a>  |  
			<a href="/technology/observability.html">Observability</a>  |  
			<a href="/technology/operations.html">Operations</a> |
			<a href="/technology/patterns.html">Patterns</a>|  
			<a href="/technology/sdlc.html">SDLC</a> |  
			<a href="/technology/scalability.html">Scalability</a>  |  
			<a href="/technology/security.html">Security</a>  |  
			<a href="/technology/transaction.html">Transactions</a>
		</li>

		<li>
			<h3>BigData</h3>
			<a href="/technology/bigdata.html">Concepts</a>  |  
			<a href="/technology/distributedcomputing.html">Distributed Computing</a>  |  
			<a href="/technology/elasticsearch.html">ElasticSearch</a>  |  
			<a href="/technology/bigdata-frameworks.html">Frameworks</a>  |  
			<a href="/technology/hadoop-ecosystem.html">Hadoop Ecosystem</a>  | 
			<a href="/technology/knowledgegraph.html">Knowledge Graph</a> |
			<a href="/technology/nosql.html">NoSQL</a>  |  
			<a href="/technology/concurrency-parallelism.html">Parallel Computing</a>
		</li>

		<li>
			<h3>Cloud Computing</h3>
			<a href="/technology/cloud-computing.html">Concepts</a>  |  
			<a href="/technology/aws.html">AWS</a>  |  
			<a href="/technology/infrastructure-as-code.html">Infrastructure as Code</a>  |  
			<a href="/technology/virtualization.html">Virtualization</a>
		</li>

		<li>
			<h3>Database</h3>
			<a href="/technology/rdbms.html">Concepts</a>  |  
			<a href="/technology/db-design.html">Design</a>  |  
			<a href="/technology/db-performance.html">Performance</a>  |  
			<a href="/technology/sql.html">SQL</a>
		</li>

		<li>
			<h3>Functional Programming</h3>
			<a href="/technology/functionalprogramming.html">Concepts</a>
		</li>

		<li>
			<h3>Java</h3>
			<a href="/technology/java.html">Core Concepts</a>  |  
			<a href="/technology/java-collections.html">Collections</a>  |  
			<a href="/technology/java-concurrency.html">Concurrency</a>  |  
			<a href="/technology/java-database.html">Database</a>  |  
			<a href="/technology/java-jmx.html">JMX</a>  |  
			<a href="/technology/java-jndi.html">JNDI</a>  |  
			<a href="/technology/java-io.html">I/O</a>  |  
			<a href="/technology/java-performance.html">Performance</a>  |  
			<a href="/technology/java-testing.html">Testing</a>  |  
			<a href="/technology/java-web.html">Web</a>  |  
			<a href="/technology/java-newsletters.html">Java Specialist Newsletters</a>
		</li>

		<li>
			<h3>Languages</h3>
			<a href="/technology/groovy.html">Groovy</a>  |  
			<a href="/technology/python.html">Python</a>  |  
			<a href="/technology/scala.html">Scala</a>
		</li>

		<li>
			<h3>Integration</h3>
			<a href="/technology/soa.html">Concepts</a>  |  
			<a href="/technology/bff.html">BFF</a> |
			<a href="/technology/camel.html">Camel</a>  |  
			<a href="/technology/graphql.html">GraphQL</a>  |  
			<a href="/technology/messaging.html">Messaging</a> |  
			<a href="/technology/microservices.html">Microservices</a>   |  
			<a href="/technology/rest-services.html">REST</a>  | 
			<a href="/technology/servicemesh.html">Service Mesh</a> |
			<a href="/technology/soap-services.html">SOAP</a>  |  
			
			<a href="/technology/webservices.html">Web Services</a> |  
			<a href="/technology/xml.html">XML</a>
		</li>

		<li>
			<h3>Spring</h3>
			<a href="/technology/spring-batch.html">Batch</a>  |  
			<a href="/technology/spring.html">Core</a>  |  
			<a href="/technology/spring-mvc.html">MVC</a> |
			<a href="/technology/spring-security.html">Security</a>
		</li>

		<li>
			<h3>Web</h3>
			<a href="/technology/webconcepts.html">Concepts</a> |
			<a href="/technology/webanalytics.html">Analytics</a> |
			<a href="/technology/angular.html">Angular</a> | 
			<a href="/technology/webapp_architecture.html">Architecture</a> | 
			<a href="/technology/js-ecosystem.html">JS Ecosystem</a> |
			<a href="/technology/microfrontend.html">Micro-Frontend</a> |
			<a href="/technology/web_security.html">Security</a> |
			<a href="/technology/ux.html">UX</a>
		</li>

		<li>
			<h3>General Concepts</h3>
			<a href="/technology/algorithms.html">Algorithms</a>  |  
			<a href="/softskills/brain-teasers.html">Brain Teasers</a>  |  
			<a href="/technology/datastructures.html">Data Structures</a>  |  
			<a href="/technology/design-faqs.html">Design FAQs</a>  |  
			<a href="/technology/networking.html">Networking</a>  |  
			<a href="/technology/oops.html">OOPS</a>  |  
			<a href="/technology/os.html">Operating Systems</a>  |  
			<a href="/technology/vcs.html">VCS</a>
		</li>

		<h2>Non-Techninal</h2>
		<li>
			<a href="/misc/okr.html">OKR</a>
		</li>
		<li>
			<h3>Domain Knowledge</h3>
			<a href="/domain/retirement.html">Retirement</a>
		</li>

		<li>
			<h3>Soft Skills</h3>
			<a href="/softskills/presentation.html">Presentation</a>  |  
			<a href="/softskills/productivity.html">Productivity</a>  |  
			<a href="/softskills/written.html">Written Communication</a>
		</li>
	</ul>

  <!-- <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
  </ul> &#8211;>
  <!-- <ul>
    <li><a href="/datascience/statistics.html">Statistics</a></li>
    <li><a href="/datascience/r.html">R Programming</a></li>
  </ul> &#8211;>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/fizalihsan">@fizalihsan</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fizalihsan',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2021 - Mohamed Fizal Ihsan Mohamed -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
