
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Spring Security - KnowledgeShop</title>
  <meta name="author" content="Mohamed Fizal Ihsan Mohamed">


<meta name="description" content="Spring Security Introduction Overriding the UserDetailsService component Overriding the endpoint authorization configuration Overriding the &hellip;">
<meta name="keywords" content="big data, data science, mongodb, nosql, R, statistics">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://fizalihsan.github.io/technology/spring-security.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!-- Below custom CSS is for table border styling -->
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  <link href="" rel="alternate" title="KnowledgeShop" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
jax: ["input/TeX", "output/HTML-CSS"],
tex2jax: {
  inlineMath: [ ['$', '$'], ["\\(","\\)"] ],
  displayMath: [ ['$$', '$$'], ["\\[","\\]"] ],
  processEscapes: true,
  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
},
messageStyle: "none",
"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript" /></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-58187831-1']);
    _gaq.push(['_setDomainName','github.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KnowledgeShop</a></h1>
  
    <h2>Learn & Share</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:fizalihsan.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  


<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Spring Security</h1>
    
  </header>
  
  <ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a>    <ul>
      <li><a href="#overriding-the-userdetailsservice-component" id="markdown-toc-overriding-the-userdetailsservice-component">Overriding the UserDetailsService component</a></li>
      <li><a href="#overriding-the-endpoint-authorization-configuration" id="markdown-toc-overriding-the-endpoint-authorization-configuration">Overriding the endpoint authorization configuration</a></li>
      <li><a href="#overriding-the-authenticationprovider-implementation" id="markdown-toc-overriding-the-authenticationprovider-implementation">Overriding the AuthenticationProvider implementation</a></li>
    </ul>
  </li>
  <li><a href="#managing-users" id="markdown-toc-managing-users">Managing Users</a>    <ul>
      <li><a href="#implementing-authentication-in-spring-security" id="markdown-toc-implementing-authentication-in-spring-security">Implementing authentication in Spring Security</a></li>
      <li><a href="#describing-the-user" id="markdown-toc-describing-the-user">Describing the user</a></li>
      <li><a href="#detailing-on-the-grantedauthority-contract" id="markdown-toc-detailing-on-the-grantedauthority-contract">Detailing on the GrantedAuthority contract</a></li>
      <li><a href="#using-a-builder-to-create-instances-of-the-userdetails-type" id="markdown-toc-using-a-builder-to-create-instances-of-the-userdetails-type">Using a builder to create instances of the UserDetails type</a></li>
      <li><a href="#understanding-the-userdetailsservice-contract" id="markdown-toc-understanding-the-userdetailsservice-contract">Understanding the UserDetailsService contract</a></li>
      <li><a href="#implementing-the-userdetailsmanager-contract" id="markdown-toc-implementing-the-userdetailsmanager-contract">Implementing the UserDetailsManager contract</a></li>
    </ul>
  </li>
  <li><a href="#dealing-with-passwords" id="markdown-toc-dealing-with-passwords">Dealing with Passwords</a>    <ul>
      <li><a href="#understanding-the-passwordencoder-contract" id="markdown-toc-understanding-the-passwordencoder-contract">Understanding the PasswordEncoder contract</a></li>
    </ul>
  </li>
  <li><a href="#implementing-authentication" id="markdown-toc-implementing-authentication">Implementing authentication</a>    <ul>
      <li><a href="#using-the-securitycontext" id="markdown-toc-using-the-securitycontext">Using the SecurityContext</a>        <ul>
          <li><a href="#using-a-holding-strategy-for-the-security-context" id="markdown-toc-using-a-holding-strategy-for-the-security-context">Using a holding strategy for the security context</a></li>
          <li><a href="#using-a-holding-strategy-for-asynchronous-calls" id="markdown-toc-using-a-holding-strategy-for-asynchronous-calls">Using a holding strategy for asynchronous calls</a></li>
          <li><a href="#using-a-holding-strategy-for-standalone-applications" id="markdown-toc-using-a-holding-strategy-for-standalone-applications">Using a holding strategy for standalone applications</a></li>
          <li><a href="#forwarding-the-security-context-with-delegatingsecuritycontextrunnable" id="markdown-toc-forwarding-the-security-context-with-delegatingsecuritycontextrunnable">Forwarding the security context with DelegatingSecurityContextRunnable</a></li>
          <li><a href="#forwarding-the-security-context-with-delegatingsecuritycontextexecutorservice" id="markdown-toc-forwarding-the-security-context-with-delegatingsecuritycontextexecutorservice">Forwarding the security context with DelegatingSecurityContextExecutorService</a></li>
          <li><a href="#using-and-configuring-http-basic" id="markdown-toc-using-and-configuring-http-basic">Using and configuring HTTP Basic</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#configuring-authorization-restricting-access" id="markdown-toc-configuring-authorization-restricting-access">Configuring authorization: Restricting access</a>    <ul>
      <li><a href="#restricting-access-based-on-authorities-and-roles" id="markdown-toc-restricting-access-based-on-authorities-and-roles">Restricting access based on authorities and roles</a></li>
      <li><a href="#restricting-access-for-all-endpoints-based-on-user-roles" id="markdown-toc-restricting-access-for-all-endpoints-based-on-user-roles">Restricting access for all endpoints based on user roles</a></li>
      <li><a href="#restricting-access-to-all-endpoints" id="markdown-toc-restricting-access-to-all-endpoints">Restricting access to all endpoints</a></li>
    </ul>
  </li>
  <li><a href="#configuring-authorization-applying-restrictions" id="markdown-toc-configuring-authorization-applying-restrictions">Configuring authorization: Applying restrictions</a>    <ul>
      <li><a href="#using-matcher-methods-to-select-endpoints" id="markdown-toc-using-matcher-methods-to-select-endpoints">Using matcher methods to select endpoints</a></li>
      <li><a href="#selecting-requests-for-authorization-using-mvc-matchers" id="markdown-toc-selecting-requests-for-authorization-using-mvc-matchers">Selecting requests for authorization using MVC matchers</a></li>
    </ul>
  </li>
  <li><a href="#implementing-filters" id="markdown-toc-implementing-filters">Implementing filters</a>    <ul>
      <li><a href="#adding-a-filter-before-an-existing-one-in-chain" id="markdown-toc-adding-a-filter-before-an-existing-one-in-chain">Adding a filter before an existing one in chain</a></li>
      <li><a href="#adding-a-filter-after-an-existing-one-in-chain" id="markdown-toc-adding-a-filter-after-an-existing-one-in-chain">Adding a filter after an existing one in chain</a></li>
      <li><a href="#adding-a-filter-at-the-location-of-another-in-the-chain" id="markdown-toc-adding-a-filter-at-the-location-of-another-in-the-chain">Adding a filter at the location of another in the chain</a></li>
      <li><a href="#filter-implementations-from-spring-security" id="markdown-toc-filter-implementations-from-spring-security">Filter implementations from Spring Security</a></li>
    </ul>
  </li>
  <li><a href="#applying-csrf" id="markdown-toc-applying-csrf">Applying CSRF</a>    <ul>
      <li><a href="#disabling-csrf-for-endpoints" id="markdown-toc-disabling-csrf-for-endpoints">Disabling CSRF for endpoints</a></li>
      <li><a href="#customizing-csrf" id="markdown-toc-customizing-csrf">Customizing CSRF</a></li>
    </ul>
  </li>
  <li><a href="#applying-cors" id="markdown-toc-applying-cors">Applying CORS</a>    <ul>
      <li><a href="#applying-cors-policies-using-crossorigin-annotation" id="markdown-toc-applying-cors-policies-using-crossorigin-annotation">Applying CORS policies using @CrossOrigin annotation</a></li>
      <li><a href="#applying-cors-using-a-corsconfigurer" id="markdown-toc-applying-cors-using-a-corsconfigurer">Applying CORS using a CorsConfigurer</a></li>
    </ul>
  </li>
  <li><a href="#references" id="markdown-toc-references">References</a></li>
</ul>

<h1 id="introduction">Introduction</h1>

<p><img src="/technology/spring-security-1.png" /></p>

<p><strong>First Intro Project</strong></p>

<ul>
  <li>Spring Boot scans for components only in the package (and its subpackages) that contains the class annotated with <code>@SpringBootApplication</code>. If you annotate classes with any of the stereotype components in Spring outside of the main package, you must explicitly declare the location using the <code>@ComponentScan</code> annotation.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Maven configuration</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">   <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">   <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">   <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">   <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Web service endpoint</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@RestController</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloController</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&quot;Hello!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<ul>
  <li>When you run the app, and access the endpoint <code>curl http://localhost:8080/hello</code>, you get the below error</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="json"><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">401</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="s2">&quot;Unauthorized&quot;</span><span class="p">,</span>
</span><span class="line">  <span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="s2">&quot;/hello&quot;</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>By default, Spring Security expects the default username (<code>user</code>). Each time you run the application, it generates a new password and prints this password in the console.</li>
  <li>It works once the generated password is passed in as input</li>
</ul>

<blockquote>
  <p>With cURL, you can set the HTTP basic username and password with the <code>-u</code> flag. Behind the scenes, cURL encodes the string <code>&lt;username&gt;:&lt;password&gt;</code> in Base64 and sends it as the value of the Authorization header prefixed with the string Basic. And with cURL, it’s probably easier for you to use the <code>-u</code> flag. But it’s also essential to know what the real request looks like. So, let’s give it a try and manually create the Authorization header.</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="c"># plain-text password</span>
</span><span class="line">curl -u user:93a01cf0-794b-4b98-86ef-54860f36f7f3 http://localhost:8080/hello
</span><span class="line">
</span><span class="line">OR
</span><span class="line">
</span><span class="line"><span class="c"># base-64 encoded</span>
</span><span class="line"><span class="nb">echo</span> -n user:93a01cf0-794b-4b98-86ef-54860f36f7f3 <span class="p">|</span> base64
</span><span class="line">curl -H <span class="s2">&quot;Authorization: Basic dXNlcjo5M2EwMWNmMC03OTRiLTRiOTgtODZlZi01NDg2MGYzNmY3ZjM=&quot;</span> localhost:8080/hello
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>High-level overview</strong></p>

<ul>
  <li>
    <p>The main components acting in the authentication process for Spring Security and the relationships among these. This architecture represents the backbone of implementing authentication with Spring Security. 
## Authentication process</p>
  </li>
  <li>Steps
    <ul>
      <li>The authentication filter delegates the authentication request to the authentication manager and, based on the response, configures the security context.</li>
      <li>The authentication manager uses the authentication provider to process authentication.</li>
      <li>The authentication provider implements the authentication logic.</li>
      <li>The user details service implements user management responsibility, which the authentication provider uses in the authentication logic.</li>
      <li>The password encoder implements password management, which the authentication provider uses in the authentication logic.</li>
      <li>The security context keeps the authentication data after the authentication process.</li>
      <li>An object that implements a <code>UserDetailsService</code> contract with Spring Security manages the details about users.</li>
    </ul>
  </li>
  <li><strong>PasswordEncoder</strong>
    <ul>
      <li>The <code>PasswordEncoder</code> does two things:
        <ul>
          <li>Encodes a password</li>
          <li>Verifies if the password matches an existing encoding</li>
        </ul>
      </li>
      <li>the <code>PasswordEncoder</code> is mandatory for the Basic authentication flow</li>
      <li>a <code>PasswordEncoder</code> exists together with the default <code>UserDetailsService</code>. When we replace the default implementation of the UserDetailsService, we must also specify a <code>PasswordEncoder</code></li>
    </ul>
  </li>
  <li><strong>AuthenticationProvider</strong>
    <ul>
      <li>The <code>AuthenticationProvider</code> defines the authentication logic, delegating the user and password management. A default implementation of the <code>AuthenticationProvider</code> uses the default implementations provided for the <code>UserDetailsService</code> and the <code>PasswordEncoder</code>. Implicitly, your application secures all the endpoints.</li>
    </ul>
  </li>
  <li><strong>Override default configurations</strong>
    <ul>
      <li>In some cases, developers choose to use beans in the Spring context for the configuration. In other cases, they override various methods for the same purpose.</li>
      <li>Configuring a project with a mix of styles is not desirable as it makes the code difficult to understand and affects the maintainability of the application.</li>
    </ul>
  </li>
</ul>

<h2 id="overriding-the-userdetailsservice-component">Overriding the UserDetailsService component</h2>

<ul>
  <li>The application now uses the instance of type UserDetailsService you added to the context instead of the default autoconfigured one. But, at the same time, you won’t be able to access the endpoint anymore for two reasons:
    <ul>
      <li>You don’t have any users.</li>
      <li>You don’t have a <code>PasswordEncoder</code>.</li>
    </ul>
  </li>
  <li>When building the instance, we have to provide the username, the password, and at least one authority. The <strong>authority</strong> is an action allowed for that user, and we can use any string for this.</li>
  <li>Because we overrode <code>UserDetailsService</code>, we also have to declare a <code>PasswordEncoder</code>. Trying the example now, you’ll see an exception when you call the endpoint. When trying to do the authentication, Spring Security realizes it doesn’t know how to manage the password and fails.</li>
  <li>The <code>NoOpPasswordEncoder</code> instance treats passwords as plain text. It doesn’t encrypt or hash them. For matching, <code>NoOpPasswordEncoder</code> only compares the strings using the underlying <code>equals(Object o)</code> method of the String class.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Bean</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">UserDetailsService</span> <span class="nf">userDetailsService</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">var</span> <span class="n">userDetailsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">InMemoryUserDetailsManager</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">var</span> <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;read&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">userDetailsService</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">userDetailsService</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Bean</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="overriding-the-endpoint-authorization-configuration">Overriding the endpoint authorization configuration</h2>

<ul>
  <li>With default configuration, all the endpoints assume you have a valid user managed by the application. Also, by default, your app uses HTTP Basic authentication as the authorization method.</li>
  <li>Not all endpoints of an application need to be secured, and for those that do, we might need to choose different authorization rules. To make such changes, we start by extending the <code>WebSecurityConfigurerAdapter</code> class. Extending this class allows us to override the <code>configure(HttpSecurity http)</code>.</li>
  <li>The <code>permitAll()</code> call in the configuration, together with the <code>anyRequest()</code> method, makes all the endpoints accessible without the need for credentials:</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Omitted code</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">();</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">           <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="overriding-the-authenticationprovider-implementation">Overriding the AuthenticationProvider implementation</h2>

<ul>
  <li>Below example shows the <code>AuthenticationProvider</code>, which implements the authentication logic and delegates to the <code>UserDetailsService</code> and <code>PasswordEncoder</code> for user and password management. So we could say that with this section, we go one step deeper in the authentication and authorization architecture to learn how to implement custom authentication logic with <code>AuthenticationProvider</code></li>
  <li>I recommend that you respect the responsibilities as designed in the Spring Security architecture. This architecture is loosely coupled with fine-grained responsibilities. That design is one of the things that makes Spring Security flexible and easy to integrate in your applications. But depending on how you make use of its flexibility, you could change the design as well. You have to be careful with these approaches as they can complicate your solution. For example, you could choose to override the default <code>AuthenticationProvider</code> in a way in which you no longer need a <code>UserDetailsService</code> or <code>PasswordEncoder</code>.</li>
</ul>

<p><img src="/technology/spring-security-2.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomAuthenticationProvider</span> <span class="kd">implements</span> <span class="n">AuthenticationProvider</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">Authentication</span> <span class="nf">authenticate</span> <span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// authentication logic here</span>
</span><span class="line">    <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">    <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">authentication</span><span class="o">.</span><span class="na">getCredentials</span><span class="o">());</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">username</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;12345&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">password</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">        <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">());</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="k">throw</span> <span class="k">new</span> <span class="nf">AuthenticationCredentialsNotFoundException</span> <span class="o">(</span><span class="s">&quot;Error in authentication!&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authenticationType</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">// type of the Authentication implementation here</span>
</span><span class="line">    <span class="k">return</span> <span class="n">UsernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">authenticationType</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Autowired</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">CustomAuthenticationProvider</span> <span class="n">authenticationProvider</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">auth</span><span class="o">.</span><span class="na">authenticationProvider</span><span class="o">(</span><span class="n">authenticationProvider</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="o">...</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><strong>Using multiple configuration classes in your project</strong>
    <ul>
      <li>good practice to separate the responsibilities even for the configuration classes. We need this separation because the configuration starts to become more complex.</li>
      <li>You can’t have both classes extending <code>WebSecurityConfigurerAdapter</code> in this case. If you do so, the dependency injection fails. You might solve the dependency injection by setting the priority for injection using the <code>@Order</code> annotation. But, functionally, this won’t work, as the configurations exclude each other instead of merging.</li>
    </ul>
  </li>
</ul>

<h1 id="managing-users">Managing Users</h1>

<ul>
  <li>Classes
    <ul>
      <li><code>UserDetails</code> - which describes the user for Spring Security.</li>
      <li><code>GrantedAuthority</code> - which allows us to define actions that the user can execute.</li>
      <li><code>UserDetailsManager</code> - which extends the <code>UserDetailsService</code> contract. Beyond the inherited behavior, it also describes actions like creating a user and modifying or deleting a user’s password.</li>
    </ul>
  </li>
</ul>

<h2 id="implementing-authentication-in-spring-security">Implementing authentication in Spring Security</h2>

<p><img src="/technology/spring-security-3.png" /></p>

<ul>
  <li>The <code>UserDetailsService</code> is only responsible for retrieving the user by username. This action is the only one needed by the framework to complete authentication.</li>
  <li>The <code>UserDetailsManager</code> adds behavior that refers to adding, modifying, or deleting the user, which is a required functionality in most applications. The separation between the two contracts is an excellent example of the interface segregation principle. Separating the interfaces allows for better flexibility because the framework doesn’t force you to implement behavior if your app doesn’t need it. If the app only needs to authenticate the users, then implementing the UserDetailsService contract is enough to cover the desired functionality.</li>
</ul>

<p><img src="/technology/spring-security-4.png" /></p>

<ul>
  <li>Dependencies between the components involved in user management. The <code>UserDetailsService</code> returns the details of a user, finding the user by its name. The <code>UserDetails</code> contract describes the user. A user has one or more authorities, represented by the <code>GrantedAuthority</code> interface. To add operations such as create, delete, or change password to the user, the <code>UserDetailsManager</code> contract extends <code>UserDetailsService</code> to add operations.</li>
</ul>

<h2 id="describing-the-user">Describing the user</h2>

<ul>
  <li>For Spring Security, a user definition should respect the <code>UserDetails</code> contract. The <code>UserDetails</code> contract represents the user as understood by Spring Security. The class of your application that describes the user has to implement this interface, and in this way, the framework understands it.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetails</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">getUsername</span><span class="o">();</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">getPassword</span><span class="o">();</span>
</span><span class="line">  <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>Spring Security uses authorities to refer either to fine-grained privileges or to roles, which are groups of privileges.</li>
</ul>

<h2 id="detailing-on-the-grantedauthority-contract">Detailing on the GrantedAuthority contract</h2>

<ul>
  <li>the actions granted for a user are called <em>authorities</em>.</li>
  <li>The authorities represent what the user can do in your application. Without authorities, all users would be equal.</li>
  <li>To create an authority, you only need to find a name for that privilege so you can refer to it later when writing the authorization rules.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GrantedAuthority</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="nf">getAuthority</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>The <code>SimpleGrantedAuthority</code> class offers a way to create immutable instances of the type GrantedAuthority.
    <ul>
      <li><code>GrantedAuthority g1 = () -&gt; "READ";</code></li>
      <li><code>GrantedAuthority g2 = new SimpleGrantedAuthority("READ");</code></li>
    </ul>
  </li>
</ul>

<h2 id="using-a-builder-to-create-instances-of-the-userdetails-type">Using a builder to create instances of the UserDetails type</h2>

<p>The <code>User</code> class from the <code>org.springframework.security.core.userdetails</code> package is a simple way to build instances of the <code>UserDetails</code> type. Using this class, you can create immutable instances of <code>UserDetails</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">UserDetails</span> <span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;bill&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;read&quot;</span><span class="o">,</span> <span class="s">&quot;write&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">accountExpired</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">disabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="understanding-the-userdetailsservice-contract">Understanding the UserDetailsService contract</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>
</span><span class="line">  <span class="n">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UsernameNotFoundException</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The authentication implementation calls the <code>loadUserByUsername(String username)</code> method to obtain the details of a user with a given username . The <code>username</code> is, of course, considered unique. The user returned by this method is an implementation of the <code>UserDetails</code> contract. If the username doesn’t exist, the method throws a <code>UsernameNotFoundException</code>.</p>

<p>The <code>AuthenticationProvider</code> is the component that implements the authentication logic and uses the <code>UserDetailsService</code> to load details about the user. To find the user by username, it calls the <code>loadUserByUsername(String username)</code> method.</p>

<p><img src="/technology/spring-security-5.png" /></p>

<h2 id="implementing-the-userdetailsmanager-contract">Implementing the UserDetailsManager contract</h2>

<p>The Spring Security authentication flow. Here we use a <code>JDBCUserDetailsManager</code> as our <code>UserDetailsService</code> component. The <code>JdbcUserDetailsManager</code> uses a database to manage users.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsManager</span> <span class="kd">extends</span> <span class="n">UserDetailsService</span> <span class="o">{</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">createUser</span><span class="o">(</span><span class="n">UserDetails</span> <span class="n">user</span><span class="o">);</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">updateUser</span><span class="o">(</span><span class="n">UserDetails</span> <span class="n">user</span><span class="o">);</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">changePassword</span><span class="o">(</span><span class="n">String</span> <span class="n">oldPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">newPassword</span><span class="o">);</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">userExists</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/technology/spring-security-6.png" /></p>

<h1 id="dealing-with-passwords">Dealing with Passwords</h1>

<h2 id="understanding-the-passwordencoder-contract">Understanding the PasswordEncoder contract</h2>

<p><img src="/technology/spring-security-7.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordEncoder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">String</span> <span class="nf">encode</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">);</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">encodedPassword</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">  <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">upgradeEncoding</span><span class="o">(</span><span class="n">String</span> <span class="n">encodedPassword</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Sha512PasswordEncoder</span> <span class="kd">implements</span> <span class="n">PasswordEncoder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">String</span> <span class="nf">encode</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nf">hashWithSHA512</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span>
</span><span class="line">    <span class="n">CharSequence</span> <span class="n">rawPassword</span><span class="o">,</span> <span class="n">String</span> <span class="n">encodedPassword</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="n">hashedPassword</span> <span class="o">=</span> <span class="n">encode</span><span class="o">(</span><span class="n">rawPassword</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">encodedPassword</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">hashedPassword</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Omitted code</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Spring Security provides the following encoders out-of-the-box:</p>

<ul>
  <li><code>NoOpPasswordEncoder</code>–Doesn’t encode the password but keeps it in cleartext. We use this implementation only for examples. Because it doesn’t hash the password, you should never use it in a real-world scenario.</li>
  <li><code>StandardPasswordEncoder</code>–Uses SHA-256 to hash the password. This implementation is now deprecated, and you shouldn’t use it for your new implementations. The reason why it’s deprecated is that it uses a hashing algorithm that we don’t consider strong enough anymore, but you might still find this implementation used in existing applications.</li>
  <li><code>Pbkdf2PasswordEncoder</code>–Uses the password-based key derivation function 2 (PBKDF2).</li>
  <li><code>BCryptPasswordEncoder</code>–Uses a bcrypt strong hashing function to encode the password.</li>
  <li><code>SCryptPasswordEncoder</code>–Uses an scrypt hashing function to encode the password.</li>
</ul>

<h1 id="implementing-authentication">Implementing authentication</h1>

<p>The authentication process, which has only two possible results:</p>

<ol>
  <li>The entity making the request is not authenticated. The user is not recognized, and the application rejects the request without delegating to the authorization process. Usually, in this case, the response status sent back to the client is <em>HTTP 401 Unauthorized</em>.</li>
  <li>The entity making the request is authenticated. The details about the requester are stored such that the application can use these for authorization. The <code>SecurityContext</code> interface is the instance that stores the details about the current authenticated request.</li>
</ol>

<p><img src="/technology/spring-security-8.png" /></p>

<p>The <code>Authentication</code> interface represents the authentication request event and holds the details of the entity that requests access to the application. You can use the information related to the authentication request event during and after the authentication process. The user requesting access to the application is called a <em>principal</em>. If you’ve ever used the Java Security API in any app, you learned that in the Java Security API, an interface named <code>Principal</code> represents the same concept.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Authentication</span> <span class="kd">extends</span> <span class="n">Principal</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>
</span><span class="line">  <span class="n">Object</span> <span class="nf">getCredentials</span><span class="o">();</span>
</span><span class="line">  <span class="n">Object</span> <span class="nf">getDetails</span><span class="o">();</span>
</span><span class="line">  <span class="n">Object</span> <span class="nf">getPrincipal</span><span class="o">();</span>
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">isAuthenticated</span><span class="o">();</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">setAuthenticated</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isAuthenticated</span><span class="o">)</span>
</span><span class="line">     <span class="kd">throws</span> <span class="n">IllegalArgumentException</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthenticationProvider</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">AuthenticationException</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authentication</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>AuthenticationProvider</code> responsibility is strongly coupled with the <code>Authentication</code> contract. The <code>authenticate()</code> method receives an <code>Authentication</code> object as a parameter and returns an <code>Authentication</code> object. We implement the <code>authenticate()</code> method to define the authentication logic.</p>

<ul>
  <li>The method should throw an <code>AuthenticationException</code> if the authentication fails.</li>
  <li>If the method receives an authentication object that is not supported by your implementation of <code>AuthenticationProvider</code>, then the method should return <code>null</code>. This way, we have the possibility of using multiple <code>Authentication</code> types separated at the HTTP-filter level.</li>
  <li>The method should return an <code>Authentication</code> instance representing a fully authenticated object. For this instance, the <code>isAuthenticated()</code> method returns true, and it contains all the necessary details about the authenticated entity. Usually, the application also removes sensitive data like a password from this instance. After implementation, the password is no longer required and keeping these details can potentially expose them to unwanted eyes.</li>
</ul>

<p>The second method in the <code>AuthenticationProvider</code> interface is <code>supports-(Class&lt;?&gt; authentication)</code>. You can implement this method to return true if the current <code>AuthenticationProvider</code> supports the type provided as an <code>Authentication</code> object. Observe that even if this method returns true for an object, there is still a chance that the <code>authenticate()</code> method rejects the request by returning null. Spring Security is designed like this to be more flexible and to allow you to implement an <code>AuthenticationProvider</code> that can reject an authentication request based on the request’s details, not only by its type.</p>

<p><img src="/technology/spring-security-9.png" /></p>

<p><code>AuthenticationManager</code> delegates to one of the available authentication providers. The <code>AuthenticationProvider</code> might not support the provided type of authentication. On the other hand, if it does support the object type, it might not know how to authenticate that specific object. The authentication is evaluated, and an <code>AuthenticationProvider</code> that can say if the request is correct or not responds to the <code>AuthenticationManager</code>.</p>

<p><img src="/technology/spring-security-10.png" /></p>

<p>If the user doesn’t exist, the <code>loadUserByUsername()</code> method should throw an <code>AuthenticationException</code>. In this case, the authentication process stops, and the HTTP filter sets the response status to HTTP 401 Unauthorized. If the username exists, we can check further the user’s password with the matches() method of the PasswordEncoder from the context. If the password does not match, then again, an <code>AuthenticationException</code> should be thrown. If the password is correct, the <code>AuthenticationProvider</code> returns an instance of <code>Authentication</code> marked as “authenticated,” which contains the details about the request.</p>

<p>To plug in the new implementation of the <code>AuthenticationProvider</code>, override the <code>configure(AuthenticationManagerBuilder auth)</code> method of the <code>WebSecurityConfigurerAdapter</code> class in the configuration class of the project.</p>

<p>Using the <code>@Autowired</code> annotation over a field declared as an <code>AuthenticationProvider</code>. Spring recognizes the <code>AuthenticationProvider</code> as an interface (which is an abstraction). But Spring knows that it needs to find in its context an instance of an implementation for that specific interface. In our case, the implementation is the instance of <code>CustomAuthenticationProvider</code>, which is the only one of this type that we declared and added to the Spring context using the <code>@Component</code> annotation.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Autowired</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">AuthenticationProvider</span> <span class="n">authenticationProvider</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">AuthenticationManagerBuilder</span> <span class="n">auth</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">auth</span><span class="o">.</span><span class="na">authenticationProvider</span><span class="o">(</span><span class="n">authenticationProvider</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Omitted code</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="using-the-securitycontext">Using the SecurityContext</h2>

<p>It is likely that you will need details about the authenticated entity after the authentication process ends. You might, for example, need to refer to the username or the authorities of the currently authenticated user. Is this information still accessible after the authentication process finishes?</p>

<p>Once the <code>AuthenticationManager</code> completes the authentication process successfully, it stores the <code>Authentication</code> instance for the rest of the request. The instance storing the <code>Authentication</code> object is called the <em>security context</em>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SecurityContext</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Authentication</span> <span class="nf">getAuthentication</span><span class="o">();</span>
</span><span class="line">  <span class="kt">void</span> <span class="nf">setAuthentication</span><span class="o">(</span><span class="n">Authentication</span> <span class="n">authentication</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>After successful authentication, the authentication filter stores the details of the authenticated entity in the security context. From there, the controller implementing the action mapped to the request can access these details when needed.</p>

<p>Spring Security offers three strategies to manage the <code>SecurityContext</code> with an object in the role of a manager. It’s named the <code>SecurityContextHolder</code>:</p>

<ol>
  <li><code>MODE_THREADLOCAL</code>–Allows each thread to store its own details in the security context. In a thread-per-request web application, this is a common approach as each request has an individual thread.</li>
  <li><code>MODE_INHERITABLETHREADLOCAL</code>–Similar to <code>MODE_THREADLOCAL</code> but also instructs Spring Security to copy the security context to the next thread in case of an asynchronous method. This way, we can say that the new thread running the @Async method inherits the security context.</li>
  <li><code>MODE_GLOBAL</code>–Makes all the threads of the application see the same security context instance.</li>
</ol>

<p><img src="/technology/spring-security-11.png" /></p>

<h3 id="using-a-holding-strategy-for-the-security-context">Using a holding strategy for the security context</h3>

<p>The first strategy for managing the security context is the <code>MODE_THREADLOCAL</code> strategy. This strategy is also the default for managing the security context used by Spring Security. With this strategy, Spring Security uses <code>ThreadLocal</code> to manage the context. This implementation works as a collection of data but makes sure that each thread of the application can see only the data stored in the collection. This way, each request has access to its security context. No thread will have access to another’s ThreadLocal. And that means that in a web application, each request can see only its own security context. We could say that this is also what you generally want to have for a backend web application.</p>

<p>Below figure offers an overview of this functionality. Each request (A, B, and C) has its own allocated thread (T1, T2, and T3). This way, each request only sees the details stored in their security context. But this also means that if a new thread is created (for example, when an asynchronous method is called), the new thread will have its own security context as well. The details from the parent thread (the original thread of the request) are not copied to the security context of the new thread.</p>

<blockquote>
  <p>This architecture only applies to the traditional servlet application where each request has its own thread assigned. It does not apply to <em>reactive</em> applications.</p>
</blockquote>

<p><img src="/technology/spring-security-12.png" /></p>

<p>Each request has its own thread, represented by an arrow. Each thread has access only to its own security context details. When a new thread is created (for example, by an <code>@Async</code> method), the details from the parent thread aren’t copied.</p>

<p>Being the default strategy for managing the security context, this process does not need to be explicitly configured. Just ask for the security context from the holder using the static <code>getContext()</code> method wherever you need it after the end of the authentication process.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Obtaining the SecurityContext from the SecurityContextHolder</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">  <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">  <span class="n">Authentication</span> <span class="n">a</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="k">return</span> <span class="s">&quot;Hello, &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Obtaining the authentication from the context is even more comfortable at the endpoint level, as Spring knows to inject it directly into the method parameters. You don’t need to refer every time to the <code>SecurityContextHolder</code> class explicitly.</p>

<h3 id="using-a-holding-strategy-for-asynchronous-calls">Using a holding strategy for asynchronous calls</h3>

<p><img src="/technology/spring-security-13.png" /></p>

<p>The situation gets more complicated if we have to deal with multiple threads per request. Look at what happens if you make the endpoint asynchronous. The thread that executes the method is no longer the same thread that serves the request.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>An @Async method served by a different thread</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/bye&quot;</span><span class="o">)</span>
</span><span class="line"><span class="nd">@Async</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">goodbye</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">  <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">  <span class="n">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// do something with the username</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>To enable the functionality of the @Async annotation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="nd">@EnableAsync</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you try the code as it is now, it throws a <code>NullPointerException</code> on the line that gets the name from the authentication, which is <code>String username = context.getAuthentication().getName()</code>.</p>

<p>This is because the method executes now on another thread that does not inherit the security context. For this reason, the <code>Authorization</code> object is null and, in the context of the presented code, causes a <code>NullPointerException</code>. In this case, you could solve the problem by using the <code>MODE_INHERITABLETHREADLOCAL</code> strategy. This can be set either by calling the <code>SecurityContextHolder.setStrategyName()</code> method or by using the system property <code>spring.security.strategy</code>. By setting this strategy, the framework knows to copy the details of the original thread of the request to the newly created thread of the asynchronous method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Using InitializingBean to set SecurityContextHolder mode</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="nd">@EnableAsync</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Bean</span>
</span><span class="line">  <span class="kd">public</span> <span class="n">InitializingBean</span> <span class="nf">initializingBean</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">setStrategyName</span><span class="o">(</span>
</span><span class="line">      <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">MODE_INHERITABLETHREADLOCAL</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<blockquote>
  <p>This works, however, only when the framework itself creates the thread (for example, in case of an <code>@Async</code> method). If your code creates the thread, you will run into the same problem even with the <code>MODE_INHERITABLETHREADLOCAL</code> strategy. This happens because, in this case, the framework does not know about the thread that your code creates.</p>
</blockquote>

<h3 id="using-a-holding-strategy-for-standalone-applications">Using a holding strategy for standalone applications</h3>

<p>If what you need is a security context shared by all the threads of the application, you change the strategy to <code>MODE_GLOBAL</code>.</p>

<p>With <code>MODE_GLOBAL</code> used as the security context management strategy, all the threads access the same security context. This implies that these all have access to the same data and can change that information. Because of this, race conditions can occur, and you have to take care of synchronization.</p>

<p>Be aware that the <code>SecurityContext</code> is not thread safe. So, with this strategy where all the threads of the application can access the <code>SecurityContext</code> object, you need to take care of concurrent access.</p>

<p><img src="/technology/spring-security-14.png" /></p>

<h3 id="forwarding-the-security-context-with-delegatingsecuritycontextrunnable">Forwarding the security context with DelegatingSecurityContextRunnable</h3>

<p>What happens when your code starts new threads without the framework knowing about them? Sometimes we name these self-managed threads because it is we who manage them, not the framework.</p>

<p>No specific strategy of the <code>SecurityContextHolder</code> offers you a solution to self-managed threads. In this case, you need to take care of the security context propagation. One solution for this is to use the <code>DelegatingSecurityContextRunnable</code> to decorate the tasks you want to execute on a separate thread. The <code>DelegatingSecurityContextRunnable</code> extends <code>Runnable</code>. You can use it following the execution of the task when there is no value expected. If you have a return value, then you can use the <code>Callable&lt;T&gt;</code> alternative, which is <code>DelegatingSecurityContextCallable&lt;T&gt;</code>. Both classes represent tasks executed asynchronously, as any other <code>Runnable</code> or <code>Callable</code>. Moreover, these make sure to copy the current security context for the thread that executes the task.</p>

<p><img src="/technology/spring-security-15.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Defining an ExecutorService and submitting the task</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">ciao</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">      <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">  <span class="o">};</span>
</span><span class="line">
</span><span class="line">  <span class="n">ExecutorService</span> <span class="n">e</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span><span class="line">  <span class="k">try</span> <span class="o">{</span>
</span><span class="line">     <span class="k">return</span> <span class="s">&quot;Ciao, &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">).</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">     <span class="n">e</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you run the application as is, you get nothing more than a <code>NullPointerException</code>. Inside the newly created thread to run the callable task, the authentication does not exist anymore, and the security context is empty. To solve this problem, we decorate the task with <code>DelegatingSecurityContextCallable</code>, which provides the current context to the new thread, as provided by this listing.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Running the task decorated by DelegatingSecurityContextCallable</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">ciao</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">  <span class="o">};</span>
</span><span class="line">
</span><span class="line">  <span class="n">ExecutorService</span> <span class="n">e</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span><span class="line">  <span class="k">try</span> <span class="o">{</span>
</span><span class="line">    <span class="n">var</span> <span class="n">contextTask</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DelegatingSecurityContextCallable</span><span class="o">&lt;&gt;(</span><span class="n">task</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&quot;Ciao, &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">contextTask</span><span class="o">).</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="forwarding-the-security-context-with-delegatingsecuritycontextexecutorservice">Forwarding the security context with DelegatingSecurityContextExecutorService</h3>

<ul>
  <li>But we have a second option to deal with the security context propagation to a new thread, and this is to manage propagation from the thread pool instead of from the task itself. An alternative to decorating tasks is to use a particular type of <code>Executor</code>.</li>
  <li>The propagation of the security context happens because an implementation called <code>DelegatingSecurityContextExecutorService</code> decorates the <code>ExecutorService</code>. It also takes care of the security context propagation.</li>
</ul>

<p><img src="/technology/spring-security-16.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Propagating the SecurityContext</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&quot;/hola&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">hola</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Callable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">task</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="n">SecurityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="n">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">();</span>
</span><span class="line">    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
</span><span class="line">  <span class="o">};</span>
</span><span class="line">
</span><span class="line">  <span class="n">ExecutorService</span> <span class="n">e</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
</span><span class="line">  <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DelegatingSecurityContextExecutorService</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class="line">  <span class="k">try</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="s">&quot;Hola, &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">).</span><span class="na">get</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;!&quot;</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">    <span class="n">e</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="using-and-configuring-http-basic">Using and configuring HTTP Basic</h3>

<ul>
  <li>For example, you might want to implement a specific logic for the case in which the authentication process fails. You might even need to set some values on the response sent back to the client in this case.</li>
  <li>You can also call the <code>httpBasic()</code> method of the <code>HttpSecurity</code> instance with a parameter of type <code>Customizer</code>. This parameter allows you to set up some configurations related to the authentication method.</li>
  <li>Also, by using a <code>Customizer</code>, we can customize the response for a failed authentication. You need to do this if the client of your system expects something specific in the response in the case of a failed authentication. You might need to add or remove one or more headers. Or you can have some logic that filters the body to make sure that the application doesn’t expose any sensitive data to the client.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="n">c</span><span class="o">.</span><span class="na">realmName</span><span class="o">(</span><span class="s">&quot;OTHER&quot;</span><span class="o">);</span>
</span><span class="line">      <span class="n">c</span><span class="o">.</span><span class="na">authenticationEntryPoint</span><span class="o">(</span><span class="k">new</span> <span class="nf">CustomEntryPoint</span><span class="o">());</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">().</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>To customize the response for a failed authentication, we can implement an <code>AuthenticationEntryPoint</code>. Its <code>commence()</code> method receives the <code>HttpServletRequest</code>, the <code>HttpServletResponse</code>, and the <code>AuthenticationException</code> that cause the authentication to fail. Below listing demonstrates a way to implement the <code>AuthenticationEntryPoint</code>, which adds a header to the response and sets the HTTP status to 401 Unauthorized.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Implementing an AuthenticationEntryPoint</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomEntryPoint</span> <span class="kd">implements</span> <span class="n">AuthenticationEntryPoint</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">commence</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span>
</span><span class="line">    <span class="n">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="n">AuthenticationException</span> <span class="n">e</span><span class="o">)</span>
</span><span class="line">      <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">      <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">addHeader</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">,</span> <span class="s">&quot;Luke, I am your father!&quot;</span><span class="o">);</span>
</span><span class="line">      <span class="n">httpServletResponse</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="n">HttpStatus</span><span class="o">.</span><span class="na">UNAUTHORIZED</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="configuring-authorization-restricting-access">Configuring authorization: Restricting access</h1>

<ul>
  <li><em>Authorization</em> is the process during which the system decides if an identified client has permission to access the requested resource</li>
  <li>In Spring Security, once the application ends the authentication flow, it delegates the request to an authorization filter. The filter allows or rejects the request based on the configured authorization rules.</li>
  <li>When the client makes the request, the authentication filter authenticates the user. After successful authentication, the authentication filter stores the user details in the security context and forwards the request to the authorization filter. The authorization filter decides whether the call is permitted. To decide whether to authorize the request, the authorization filter uses the details from the security context.</li>
</ul>

<p><img src="/technology/spring-security-17.png" /></p>

<h2 id="restricting-access-based-on-authorities-and-roles">Restricting access based on authorities and roles</h2>

<ul>
  <li>A user has one or more authorities (actions that a user can do). During the authentication process, the <code>UserDetailsService</code> obtains all the details about the user, including the authorities. The application uses the authorities as represented by the <code>GrantedAuthority</code> interface for authorization after it successfully authenticates the user</li>
  <li>An <em>authority</em> is an action that a user can perform with a system resource. An authority has a name that the <code>getAuthority()</code> behavior of the object returns as a <code>String</code>. We use the name of the authority when defining the custom authorization rule. Often an authorization rule can look like this: <em>“Jane is allowed to delete the product records,”</em> or <em>“John is allowed to read the document records.”</em> In these cases, delete and read are the granted authorities. The application allows the users Jane and John to perform these actions, which often have names like read, write, or delete.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>The GrantedAuthority contract</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GrantedAuthority</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">getAuthority</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>The getAuthorities() method from the UserDetails contract</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetails</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">  <span class="n">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="c1">// Omitted code</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><img src="/technology/spring-security-18.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Restricting access for all endpoints based on user authorities</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">var</span> <span class="n">user1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;READ&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span><span class="line">
</span><span class="line"><span class="n">var</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;jane&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;WRITE&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You provide the name of the authority allowed to the user as a parameter of the <code>hasAuthority()</code> method. The application needs, first, to authenticate the request and then, based on the user’s authorities, the app decides whether to allow the call.</p>

<p>__1. <code>hasAuthority()</code> method</p>

<p><code>hasAuthority('WRITE')</code> – Stipulates that the user needs the WRITE authority to call the endpoint.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Restricting access to only users having WRITE authority</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">  <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">  <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">        <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
</span><span class="line">        <span class="o">.</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">&quot;WRITE&quot;</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>__2. <code>hasAnyAuthority()</code> method</p>

<p><code>hasAnyAuthority('READ', 'WRITE')</code>–Specifies that the user needs one of either the READ or WRITE authorities. With this expression, you can enumerate all the authorities for which you want to allow access.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Applying the hasAnyAuthority() method</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">          <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="s">&quot;WRITE&quot;</span><span class="o">,</span> <span class="s">&quot;READ&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>__3. <code>access()</code> method</p>

<p>To specify access based on user authorities, the third way you find in practice is the <code>access()</code> method. The <code>access()</code> method is more general, however. It receives as a parameter a <strong>Spring expression (SpEL)</strong> that specifies the authorization condition. This method is powerful, and it doesn’t refer only to authorities. However, this method also makes the code more difficult to read and understand. For this reason, I recommend it as the last option, and only if you can’t apply one of the <code>hasAuthority()</code> or <code>hasAnyAuthority()</code> methods presented earlier.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Using the access() method to configure access to the endpoints</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">          <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">access</span><span class="o">(</span><span class="s">&quot;hasAuthority(&#39;WRITE&#39;)&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Applying the access() method with a more complex expression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">String</span> <span class="n">expression</span> <span class="o">=</span> <span class="s">&quot;hasAuthority(&#39;read&#39;) and !hasAuthority(&#39;delete&#39;)&quot;</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">    <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
</span><span class="line">    <span class="o">.</span><span class="na">access</span><span class="o">(</span><span class="n">expression</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="restricting-access-for-all-endpoints-based-on-user-roles">Restricting access for all endpoints based on user roles</h2>

<ul>
  <li>Roles are coarse grained. Each user with a specific role can only do the actions granted by that role. When applying this philosophy in authorization, a request is allowed based on the purpose of the user in the system. Only users who have a specific role can call a certain endpoint.</li>
  <li>Imagine, in your application, a user can either only have read authority or have all: read, write, and delete authorities. In this case, it might be more comfortable to think that those users who can only read have a role named READER, while the others have the role ADMIN. Having the ADMIN role means that the application grants you read, write, update, and delete privileges.</li>
  <li>Roles are represented using the same contract in Spring Security <code>GrantedAuthority</code>. When defining a role, its name should start with the <code>ROLE_</code> prefix. At the implementation level, this prefix specifies the difference between a role and an authority.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Setting roles for users</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">var</span> <span class="n">user1</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;ROLE_ADMIN&quot;</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">var</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">&quot;jane&quot;</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">password</span><span class="o">(</span><span class="s">&quot;12345&quot;</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">authorities</span><span class="o">(</span><span class="s">&quot;ROLE_MANAGER&quot;</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To set constraints for user roles, you can use one of the following methods:</p>

<ol>
  <li><code>hasRole()</code>–Receives as a parameter the role name for which the application authorizes the request.</li>
  <li><code>hasAnyRole()</code>–Receives as parameters the role names for which the application approves the request.</li>
  <li><code>access()</code>–Uses a Spring expression to specify the role or roles for which the application authorizes requests. In terms of roles, you could use <code>hasRole()</code> or <code>hasAnyRole()</code> as SpEL expressions.</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Configuring the app to accept only requests from admins</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">         <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&quot;ADMIN&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When building users with the User builder class as we did in the example for this section, you specify the role by using the <code>roles()</code> method. This method creates the <code>GrantedAuthority</code> object and automatically adds the <code>ROLE_</code> prefix to the names you provide.</p>

<blockquote>
  <p>Make sure the parameter you provide for the <code>roles()</code> method DOES NOT include the <code>ROLE_</code> prefix. If that prefix is inadvertently included in the <code>role()</code> parameter, the method throws an exception. In short, when using the <code>authorities()</code> method, include the <code>ROLE_</code> prefix. When using the <code>roles()</code> method, do not include the <code>ROLE_</code> prefix.</p>
</blockquote>

<p>Important to remember that the <code>access()</code> method is generic. For example, to configure access to the endpoint to be allowed only after 12:00 pm, you can use the following SpEL expression:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">LocalTime</span><span class="o">).</span><span class="na">now</span><span class="o">().</span><span class="na">isAfter</span><span class="o">(</span><span class="n">T</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">LocalTime</span><span class="o">).</span><span class="na">of</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="restricting-access-to-all-endpoints">Restricting access to all endpoints</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Using the denyAll() method to restrict access to endpoints</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">         <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">denyAll</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="configuring-authorization-applying-restrictions">Configuring authorization: Applying restrictions</h1>

<h2 id="using-matcher-methods-to-select-endpoints">Using matcher methods to select endpoints</h2>

<ul>
  <li>We use matcher methods to choose the requests to which we apply authorization configuration.</li>
  <li>Requests can be selected by path, by HTTP method or both.</li>
  <li>Spring Security offers you three types of matcher methods:</li>
</ul>

<ol>
  <li><strong>MVC matchers</strong>–You use MVC expressions for paths to select endpoints.</li>
  <li><strong>Ant matchers</strong>–You use Ant expressions for paths to select endpoints.</li>
  <li><strong>regex matchers</strong>–You use regular expressions (regex) for paths to select endpoints.</li>
</ol>

<p><strong>MVC matchers</strong></p>

<ul>
  <li>We create an application that exposes two endpoints: <code>/hello</code> and <code>/ciao</code>. We want to make sure that only users having the ADMIN role can call the <code>/hello</code> endpoint. Similarly, we want to make sure that only users having the MANAGER role can call the <code>/ciao</code> endpoint.</li>
  <li>To specify that only users having the ADMIN role can call the endpoint <code>/hello</code> when authorizing requests, we use the <code>mvcMatchers()</code> method.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">         <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&quot;ADMIN&quot;</span><span class="o">)</span>
</span><span class="line">         <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&quot;MANAGER&quot;</span><span class="o">);</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you now add any other endpoint to your application, it is accessible by default to anyone, even unauthenticated users.</p>

<p>The <code>permitAll()</code> method states that all other requests are allowed without authentication.</p>

<blockquote>
  <p>When you use matchers to refer to requests, the order of the rules should be from particular to general. This is why the <code>anyRequest()</code> method cannot be called before a more specific matcher method like <code>mvcMatchers()</code>.</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Marking additional requests explicitly as accessible without authentication</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">           <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&quot;ADMIN&quot;</span><span class="o">)</span>
</span><span class="line">           <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&quot;MANAGER&quot;</span><span class="o">)</span>
</span><span class="line">           <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you have designed an endpoint to be accessible to anyone, you can call it without providing a username and a password for authentication. In this case, Spring Security won’t do the authentication. If you, however, provide a username and a password, Spring Security evaluates them in the authentication process. If they are wrong (not known by the system), authentication fails, and the response status will be 401 Unauthorized. To be more precise, if you call the /hola endpoint for the configuration presented in listing 8.4, the app returns the body “Hola!” as expected, and the response status is 200 OK.</p>

<p><img src="/technology/spring-security-19.png" /></p>

<p>The authorization filter allows any request to the <code>/hola</code> path. But because the application first executes the authentication logic, the request is never forwarded to the authorization filter. Instead, the authentication filter replies with an HTTP 401 Unauthorized.</p>

<p>The <code>permitAll()</code> method refers to authorization configuration only, and if authentication fails, the call will not be allowed further.</p>

<p>To make all the other endpoints accessible only for authenticated users. To do this, you would change the <code>permitAll()</code> method with <code>authenticated()</code> as presented in the following listing. Similarly, you could even deny all other requests by using the <code>denyAll()</code> method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Making other requests accessible for all authenticated users</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span>
</span><span class="line">    <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">httpBasic</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">     <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">           <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&quot;/hello&quot;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&quot;ADMIN&quot;</span><span class="o">)</span>
</span><span class="line">           <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">&quot;MANAGER&quot;</span><span class="o">)</span>
</span><span class="line">           <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Multiple endpoints can have the same authorization rules, so you don’t have to set them up endpoint by endpoint</p>

<h2 id="selecting-requests-for-authorization-using-mvc-matchers">Selecting requests for authorization using MVC matchers</h2>

<p>This matcher uses the standard MVC syntax for referring to paths. This syntax is the same one you use when writing endpoint mappings with annotations like @RequestMapping, <code>@GetMapping</code>, <code>@PostMapping</code>, and so forth. The two methods you can use to declare MVC matchers are as follows:</p>

<ul>
  <li><code>mvcMatchers(HttpMethod method, String... patterns)</code>–Lets you specify both the HTTP method to which the restrictions apply and the paths. This method is useful if you want to apply different restrictions for different HTTP methods for the same path.</li>
  <li><code>mvcMatchers(String... patterns)</code>–Simpler and easier to use if you only need to apply authorization restrictions based on paths. The restrictions can automatically apply to any HTTP method used with the path.</li>
</ul>

<p>Spring Security applies, by default, protection against cross-site request forgery (CSRF).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Authorization configuration for the first scenario,</span><a href="/a">link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">,</span> <span class="s">&quot;/a&quot;</span><span class="o">)</span>
</span><span class="line">               <span class="o">.</span><span class="na">authenticated</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">,</span> <span class="s">&quot;/a&quot;</span><span class="o">)</span>
</span><span class="line">               <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
</span><span class="line">               <span class="o">.</span><span class="na">denyAll</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>For the current project, we want to ensure that the same rules apply for all requests for paths starting with <code>/a/b</code>. These paths in our case are <code>/a/b</code> and <code>/a/b/c</code>. To achieve this, we use the <code>**</code> operator. (Spring MVC borrows the path-matching syntaxes from Ant.)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Changes in the configuration class for multiple paths</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"> <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">          <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span> <span class="s">&quot;/a/b/**&quot;</span><span class="o">)</span>
</span><span class="line">             <span class="o">.</span><span class="na">authenticated</span><span class="o">()</span>
</span><span class="line">          <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
</span><span class="line">             <span class="o">.</span><span class="na">permitAll</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>**</code> operator refers to any number of pathnames. You can use it as we have done in the last example so that you can match requests with paths having a known prefix. You can also use it in the middle of a path to refer to any number of pathnames or to refer to paths ending in a specific pattern like <code>/a/**/c</code>. Therefore, <code>/a/**/c</code> would not only match <code>/a/b/c</code> but also <code>/a/b/d/c</code> and <code>a/b/c/d/e/c</code> and so on. If you only want to match one pathname, then you can use a single <code>*</code>. For example, <code>a/*/c</code> would match <code>a/b/c</code> and <code>a/d/c</code> but not <code>a/b/d/c</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Configuring the authorization to permit only specific digits</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">         <span class="o">.</span><span class="na">mvcMatchers</span><span class="o">(</span><span class="s">&quot;/product/{code:^[0-9]*$}&quot;</span><span class="o">)</span> <span class="c1">//The regex refers to strings of any length, containing any digit.</span>
</span><span class="line">              <span class="o">.</span><span class="na">permitAll</span><span class="o">()</span>
</span><span class="line">         <span class="o">.</span><span class="na">anyRequest</span><span class="o">()</span>
</span><span class="line">              <span class="o">.</span><span class="na">denyAll</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Common expressions used for path matching with MVC matchers</p>

<table>
  <tbody>
    <tr>
      <td>Expression</td>
      <td>Description</td>
    </tr>
    <tr>
      <td><code>/a</code></td>
      <td>Only path /a.</td>
    </tr>
    <tr>
      <td><code>/a/*</code></td>
      <td>The * operator replaces one pathname. In this case, it matches /a/b or /a/c, but not /a/b/c.</td>
    </tr>
    <tr>
      <td><code>/a/**</code></td>
      <td>The ** operator replaces multiple pathnames. In this case, /a as well as /a/b and /a/b/c are a match for this expression.</td>
    </tr>
    <tr>
      <td><code>/a/{param}</code></td>
      <td>This expression applies to the path /a with a given path parameter.</td>
    </tr>
    <tr>
      <td><code>/a/{param:regex}</code></td>
      <td>This expression applies to the path /a with a given path parameter only when the value of the parameter matches the given regular expression.</td>
    </tr>
  </tbody>
</table>

<p><strong>Ant matchers</strong></p>

<p>The Ant matchers apply exactly the given Ant expressions for patterns but know nothing about subtle Spring MVC functionality. In this case, <code>/hello</code> doesn’t apply as an Ant expression to the <code>/hello/</code> path. If you also want to secure the <code>/hello/</code> path, you have to individually add it or write an Ant expression that matches it as well.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">          <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span> <span class="s">&quot;/hello&quot;</span><span class="o">).</span><span class="na">authenticated</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="implementing-filters">Implementing filters</h1>

<ul>
  <li>In Spring Security, in general, HTTP filters manage each responsibility that must be applied to the request. The filters form a chain of responsibilities.</li>
  <li>The filter chain receives the request. Each filter uses a manager to apply specific logic to the request and, eventually, delegates the request further along the chain to the next filter.</li>
  <li>Spring Security provides filter implementations that you add to the filter chain through customization, but you can also define custom filters.</li>
</ul>

<p><img src="/technology/spring-security-20.png" /></p>

<p>You can customize the filter chain by adding new filters before, after, or at the position of existing ones. This way, you can customize authentication as well as the entire process applied to request and response.</p>

<p><img src="/technology/spring-security-21.png" /></p>

<ul>
  <li>Custom filters can created by implementing the <code>javax.servlet.Filter</code> package.</li>
  <li>Default implementations from Spring Security:
    <ul>
      <li><code>BasicAuthenticationFilter</code> takes care of HTTP Basic authentication, if present.</li>
      <li><code>CsrfFilter</code> takes care of cross-site request forgery (CSRF) protection.</li>
      <li><code>CorsFilter</code> takes care of cross-origin resource sharing (CORS) authorization rules,</li>
    </ul>
  </li>
  <li>Call to the <code>httpBasic()</code> method, an instance of the <code>BasicAuthenticationFilter</code> is added to the chain.</li>
  <li>Each filter has an order number. This determines the order in which filters are applied to a request. You can add custom filters along with the filters provided by Spring Security.</li>
</ul>

<p><img src="/technology/spring-security-22.png" /></p>

<ul>
  <li>If multiple filters have the same position, the order in which they are called is not defined.</li>
</ul>

<p><img src="/technology/spring-security-23.png" /></p>

<h2 id="adding-a-filter-before-an-existing-one-in-chain">Adding a filter before an existing one in chain</h2>

<ul>
  <li>For our example, we add a <code>RequestValidationFilter</code>, which acts before the authentication filter. The <code>RequestValidationFilter</code> ensures that authentication doesn’t happen if the validation of the request fails.</li>
  <li>In our case, the request must have a mandatory header named <code>RequestId</code>. If the header doesn’t exist, we set an HTTP status 400 Bad Request on the response without forwarding it to the next filter in the chain.</li>
</ul>

<p><img src="/technology/spring-security-24.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Filter implementation</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>
</span><span class="line">    <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">var</span> <span class="n">httpRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
</span><span class="line">  <span class="n">var</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="n">String</span> <span class="n">requestId</span> <span class="o">=</span> <span class="n">httpRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&quot;Request-Id&quot;</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">  <span class="k">if</span> <span class="o">(</span><span class="n">requestId</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">requestId</span><span class="o">.</span><span class="na">isBlank</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">      <span class="n">httpResponse</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_BAD_REQUEST</span><span class="o">);</span>
</span><span class="line">      <span class="k">return</span><span class="o">;</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line">
</span><span class="line">  <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Configuring the filter</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span>
</span><span class="line">            <span class="k">new</span> <span class="nf">RequestValidationFilter</span><span class="o">(),</span>
</span><span class="line">            <span class="n">BasicAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="adding-a-filter-after-an-existing-one-in-chain">Adding a filter after an existing one in chain</h2>

<p><img src="/technology/spring-security-25.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">addFilterBefore</span><span class="o">(</span>
</span><span class="line">            <span class="k">new</span> <span class="nf">RequestValidationFilter</span><span class="o">(),</span>
</span><span class="line">            <span class="n">BasicAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="na">addFilterAfter</span><span class="o">(</span>
</span><span class="line">            <span class="k">new</span> <span class="nf">AuthenticationLoggingFilter</span><span class="o">(),</span>
</span><span class="line">            <span class="n">BasicAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="adding-a-filter-at-the-location-of-another-in-the-chain">Adding a filter at the location of another in the chain</h2>

<ul>
  <li>In this section, we discuss adding a filter at the location of another one in the filter chain. You use this approach especially when providing a different implementation for a responsibility that is already assumed by one of the filters known by Spring Security.</li>
  <li>A typical scenario is replacing HTTP Basic authentication flow in following scenarios:
    <ol>
      <li>Identification based on a static header value for authentication</li>
      <li>Using a symmetric key to sign the request for authentication</li>
      <li>Using a one-time password (OTP) in the authentication process</li>
    </ol>
  </li>
</ul>

<p><strong>1. Identification based on a static header value for authentication</strong></p>

<ul>
  <li>This approach  offers weak security related to authentication, but architects and developers often choose it in calls between backend applications for its simplicity.</li>
  <li>The request contains a header with the value of the static key. If this value matches the one known by the application, it accepts the request.</li>
</ul>

<p><img src="/technology/spring-security-26.png" /></p>

<p><strong>2. Using a symmetric key to sign the request for authentication</strong></p>

<ul>
  <li>In this scenario, using symmetric keys to sign and validate requests, both client and server know the value of a key (client and server share the key). The client uses this key to sign a part of the request (for example, to sign the value of specific headers), and the server checks if the signature is valid using the same key . The server can store individual keys for each client in a database or a secrets vault. Similarly, you can use a pair of asymmetric keys.</li>
  <li>The Authorization header contains a value signed with a key known by both client and server (or a private key for which the server has the public pair). The application checks the signature and, if correct, allows the request.</li>
</ul>

<p><img src="/technology/spring-security-27.png" /></p>

<p><strong>3. Using a one-time password (OTP) in the authentication process</strong></p>

<ul>
  <li>And finally, using an OTP in the authentication process, the user receives the OTP via a message or by using an authentication provider app like Google Authenticator.</li>
  <li>To access the resource, the client has to use a one-time password (OTP). The client obtains the OTP from a third-party authentication server. Generally, applications use this approach during login when multifactor authentication is required.</li>
</ul>

<p><img src="/technology/spring-security-28.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Custom auth filter</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StaticKeyAuthenticationFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Value</span><span class="o">(</span><span class="s">&quot;${authorization.key}&quot;</span><span class="o">)</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">String</span> <span class="n">authorizationKey</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span>
</span><span class="line">    <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="n">var</span> <span class="n">httpRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">request</span><span class="o">;</span>
</span><span class="line">    <span class="n">var</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">)</span> <span class="n">response</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="n">String</span> <span class="n">authentication</span> <span class="o">=</span> <span class="n">httpRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&quot;Authorization&quot;</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">authorizationKey</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">authentication</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="n">httpResponse</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_UNAUTHORIZED</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Adding the filter in the configuration</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Autowired</span>
</span><span class="line">  <span class="kd">private</span> <span class="n">StaticKeyAuthenticationFilter</span> <span class="n">filter</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">addFilterAt</span><span class="o">(</span><span class="n">filter</span><span class="o">,</span> <span class="n">BasicAuthenticationFilter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class="line">        <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">           <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>When <code>UserDetailsService</code> is not defined, Spring Boot automatically configures one. But in our scenario, we don’t need a <code>UserDetailsService</code> at all because the concept of the user doesn’t exist. We only validate that the user requesting to call an endpoint on the server knows a given value. Application scenarios are not usually this simple and often require a <code>UserDetailsService</code>. But, if you anticipate or have such a case where this component is not needed, you can disable autoconfiguration.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>To disable the default UserDetailsService</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@SpringBootApplication</span><span class="o">(</span><span class="n">exclude</span> <span class="o">=</span> <span class="o">{</span><span class="n">UserDetailsServiceAutoConfiguration</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="filter-implementations-from-spring-security">Filter implementations from Spring Security</h2>

<ul>
  <li>Spring Security offers a few abstract classes that implement the <code>Filter</code> interface and for which you can extend your filter definitions.</li>
  <li>For example, you could extend the <code>GenericFilterBean</code> class, which allows you to use initialization parameters that you would define in a <code>web.xml</code> descriptor file where applicable.</li>
  <li>A more useful class that extends the <code>GenericFilterBean</code> is <code>OncePerRequestFilter</code>. When adding a filter to the chain, the framework doesn’t guarantee it will be called only once per request. <code>OncePerRequestFilter</code>, as the name suggests, implements logic to make sure that the filter’s <code>doFilter()</code> method is executed only one time per request.</li>
</ul>

<h1 id="applying-csrf">Applying CSRF</h1>

<ul>
  <li>CSRF (Cross-site request forgery) protection, which is enabled by default in Spring Security</li>
  <li><strong>How CSRF works?</strong>
    <ul>
      <li>CSRF attacks assume that a user is logged into a web application. They’re tricked by the attacker into opening a page that contains scripts that execute actions in the same application the user was working on. Because the user has already logged in (as we’ve assumed from the beginning), the forgery code can now impersonate the user and do actions on their behalf.</li>
    </ul>
  </li>
  <li><strong>How do we protect our users from such scenarios?</strong>
    <ul>
      <li>What CSRF protection wants to ensure is that only the frontend of web applications can perform mutating operations (by convention, HTTP methods other than GET, HEAD, TRACE, or OPTIONS). Then, a foreign page, like the one in our example, can’t act on behalf of the user.</li>
    </ul>
  </li>
  <li><strong>How can we achieve this?</strong>
    <ul>
      <li>What you know for sure is that before being able to do any action that could change data, a user must send a request using HTTP GET to see the web page at least once. When this happens, the application generates a <em>unique token</em>.</li>
      <li>The application now accepts only requests for mutating operations (POST, PUT, DELETE, and so forth) that contain this unique value in the header. The application considers that knowing the value of the token is proof that it is the app itself making the mutating request and not another system.</li>
      <li>Any page containing mutating calls, like POST, PUT, DELETE, and so on, should receive through the response the CSRF token, and the page must use this token when making mutating calls.</li>
    </ul>
  </li>
  <li><strong>Spring Security CsrfFilter</strong>
    <ul>
      <li>The starting point of CSRF protection is a filter in the filter chain called <code>CsrfFilter</code>.</li>
      <li>The <code>CsrfFilter</code> intercepts requests and allows all those that use these HTTP methods: GET, HEAD, TRACE, and OPTIONS.</li>
      <li>For all other requests, the filter expects to receive a header containing a token. If this header does not exist or contains an incorrect token value, the application rejects the request and sets the status of the response to HTTP 403 Forbidden.</li>
    </ul>
  </li>
</ul>

<p><img src="/technology/spring-security-29.png" /></p>

<ul>
  <li><strong>What is this token, and where does it come from?</strong>
    <ul>
      <li>These tokens are nothing more than string values. You have to add the token in the header of the request when you use any method other than GET, HEAD, TRACE, or OPTIONS. If you don’t add the header containing the token, the application doesn’t accept the request.</li>
      <li>The <code>CsrfFilter</code> uses a component named <code>CsrfTokenRepository</code> to manage the CSRF token values that generate new tokens, store tokens, and eventually invalidate these.</li>
      <li>By default, the <code>CsrfTokenRepository</code> stores the token on the HTTP session and generates the tokens as random universally unique identifiers (UUIDs).</li>
    </ul>
  </li>
</ul>

<p><img src="/technology/spring-security-30.png" /></p>

<p>Adding the <code>CsrfTokenLogger</code> (shaded) after the <code>CsrfFilter</code>. This way, the <code>CsrfTokenLogger</code> can obtain the value of the token from the <code>_csrf</code> attribute of the request where the <code>CsrfFilter</code> stores it. The <code>CsrfTokenLogger</code> prints the CSRF token in the application console, where we can access it and use it to call an endpoint with the HTTP POST method.</p>

<p><img src="/technology/spring-security-31.png" /></p>

<p>While calling the POST endpoint you also need to specify the session ID (<code>JSESSIONID</code>) because the default implementation of <code>CsrfTokenRepository</code> stores the value of the CSRF token on the session</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">curl -X POST   http://localhost:8080/hello
</span><span class="line">-H <span class="s1">&#39;Cookie: JSESSIONID=21ADA55E10D70BA81C338FFBB06B0206&#39;</span>
</span><span class="line">-H <span class="s1">&#39;X-CSRF-TOKEN: 1127bfda-57b1-43f0-bce5-bacd7d94694e&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>You use CSRF protection for web apps running in a browser, where you should expect that mutating operations can be done by the browser that loads the displayed content of the app.</li>
  <li>Did you notice that the login operation in that application used HTTP POST? Then why didn’t we need to do anything explicitly about CSRF in that case? The reason why we didn’t observe this was because we didn’t develop any mutating operation within it ourselves.</li>
  <li>For the default login, Spring Security correctly applies CSRF protection for us. The framework takes care of adding the CSRF token to the login request.</li>
  <li>After running the application, you can access the default login page. If you inspect the form using the inspect element function of your browser, you can observe that the default implementation of the login form sends the CSRF token. This is why your login works with CSRF protection enabled even if it uses an HTTP POST request</li>
  <li>The default form login uses a hidden input to send the CSRF token in the request. This is why the login request that uses an HTTP POST method works with CSRF protection enabled.</li>
</ul>

<p><img src="/technology/spring-security-32.png" /></p>

<ul>
  <li>For any action or asynchronous JavaScript request your page uses to call a mutable action, you need to send a valid CSRF token. This is the most common way used by an application to make sure the request doesn’t come from a third party. A third-party request could try to impersonate the user to execute actions on their behalf.</li>
</ul>

<p><strong>Downsides of CSRF tokens</strong></p>

<ul>
  <li>CSRF tokens work well in an architecture where the same server is responsible for both the frontend and the backend, mainly for its simplicity. But CSRF tokens don’t work well when the client is independent of the backend solution it consumes. This scenario happens when you have a mobile application as a client or a web frontend developed independently (Angular, ReactJS, or Vue.js). This is why you need to know how to implement the security approach for these cases as well.</li>
</ul>

<h2 id="disabling-csrf-for-endpoints">Disabling CSRF for endpoints</h2>

<ul>
  <li>By default, CSRF protection applies to any path for endpoints called with HTTP methods other than GET, HEAD, TRACE, or OPTIONS</li>
  <li>CSRF can be disabled for certain endpoints only as follows:
    <ul>
      <li><strong>Ant Expressions</strong>
        <ul>
          <li>Calling the <code>ignoringAntMatchers(String paths)</code> method, you can specify the Ant expressions representing the paths that you want to exclude from the CSRF protection mechanism.</li>
        </ul>
      </li>
      <li><strong>MVC Expressions</strong>
        <ul>
          <li>A more general approach is to use a <code>RequestMatcher</code>. Using this allows you to apply the exclusion rules with regular MVC expressions as well as with regexes (regular expressions).</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Ant expression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">        <span class="n">c</span><span class="o">.</span><span class="na">ignoringAntMatchers</span><span class="o">(</span><span class="s">&quot;/ciao&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="o">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>MVC expression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">HandlerMappingIntrospector</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HandlerMappingIntrospector</span><span class="o">();</span>
</span><span class="line"><span class="n">MvcRequestMatcher</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MvcRequestMatcher</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="s">&quot;/ciao&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">c</span><span class="o">.</span><span class="na">ignoringRequestMatchers</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Regex expression</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">String</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s">&quot;.*[0-9].*&quot;</span><span class="o">;</span>
</span><span class="line"><span class="n">String</span> <span class="n">httpMethod</span> <span class="o">=</span> <span class="n">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">.</span><span class="na">name</span><span class="o">();</span>
</span><span class="line"><span class="n">RegexRequestMatcher</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">RegexRequestMatcher</span><span class="o">(</span><span class="n">pattern</span><span class="o">,</span> <span class="n">httpMethod</span><span class="o">);</span>
</span><span class="line"><span class="n">c</span><span class="o">.</span><span class="na">ignoringRequestMatchers</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="customizing-csrf">Customizing CSRF</h2>

<ul>
  <li>Another need often found in the requirements of the application is customizing the management of CSRF tokens.</li>
  <li>By default, the application stores CSRF tokens in the HTTP session on the server side. This simple approach is suitable for small applications, but it’s not great for applications that serve a large number of requests and that require horizontal scaling. The HTTP session is stateful and reduces the scalability of the application.</li>
  <li>Spring Security offers two contracts that you need to implement to do this:
    <ul>
      <li><code>CsrfToken</code>–Describes the CSRF token itself</li>
      <li><code>CsrfTokenRepository</code>–Describes the object that creates, stores, and loads CSRF tokens</li>
    </ul>
  </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CsrfToken</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="n">String</span> <span class="nf">getHeaderName</span><span class="o">();</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">getParameterName</span><span class="o">();</span>
</span><span class="line">  <span class="n">String</span> <span class="nf">getToken</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><code>DefaultCsrfToken</code> implements the <code>CsrfToken</code> contract and creates immutable instances containing the required values: the name of the request attribute and header, and the token itself.</li>
  <li>Example
    <ul>
      <li>The <code>CsrfToken</code> uses a custom implementation of <code>CsrfTokenRepository</code>. This custom implementation uses a <code>JpaRepository</code> to manage CSRF tokens in a database.</li>
      <li><strong>Approach 1: Tokens associated to userId</strong>: In our example, we use a table in a database to store CSRF tokens. We assume the client has an ID to identify themselves uniquely. The application needs this identifier to obtain the CSRF token and validate it. Generally, this unique ID would be obtained during login and should be different each time the user logs in. This strategy of managing tokens is similar to storing them in memory. In this case, you use a session ID. So the new identifier for this example merely replaces the session ID.</li>
      <li><strong>Approach 2: With token expiry</strong>: An alternative to this approach would be to use CSRF tokens with a defined lifetime. With such an approach, tokens expire after a time you define. You can store tokens in the database without linking them to a specific user ID. You only need to check if a token provided via an HTTP request exists and is not expired to decide whether you allow that request.</li>
    </ul>
  </li>
</ul>

<p><img src="/technology/spring-security-33.png" /></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>The implementation of the generateToken() method</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="n">CsrfToken</span> <span class="nf">generateToken</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="n">String</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span><span class="line">  <span class="k">return</span> <span class="k">new</span> <span class="nf">DefaultCsrfToken</span><span class="o">(</span><span class="s">&quot;X-CSRF-TOKEN&quot;</span><span class="o">,</span> <span class="s">&quot;_csrf&quot;</span><span class="o">,</span> <span class="n">uuid</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="applying-cors">Applying CORS</h1>

<ul>
  <li>Cross-origin resource sharing (CORS)
    <ul>
      <li>The necessity for CORS came from web applications. By default, browsers don’t allow requests made for any domain other than the one from which the site is loaded. For example, if you access the site from <code>example.com</code>, the browser won’t let the site make requests to <code>api.example.com</code>.</li>
    </ul>
  </li>
  <li><strong>How CORS works?</strong>
    <ul>
      <li>Even if the <code>example.org</code> page is loaded in an <em>iframe</em> from the <code>example.com</code> domain, the calls from the content loaded in <code>example.org</code> won’t load. Even if the application makes a request, the browser won’t accept the response.</li>
      <li>Any situation in which an application makes calls between two different domains is prohibited. (even if the port numbers are different on the same host)</li>
    </ul>
  </li>
</ul>

<p><img src="/technology/spring-security-34.png" /></p>

<ul>
  <li><strong>How to resolve?</strong>
    <ul>
      <li>CORS allows you to specify from which domain your application allows requests and what details can be shared. The CORS mechanism works based on HTTP headers . The most important are
        <ul>
          <li><code>Access-Control-Allow-Origin</code>–Specifies the foreign domains (origins) that can access resources on your domain.</li>
          <li><code>Access-Control-Allow-Methods</code>–Lets us refer only to some HTTP methods in situations in which we want to allow access to a different domain, but only to specific HTTP methods. You use this if you’re going to enable <em>example.com</em> to call some endpoint, but only with HTTP GET, for example.</li>
          <li><code>Access-Control-Allow-Headers</code>–Adds limitations to which headers you can use in a specific request.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p><img src="/technology/spring-security-35.png" /></p>

<ul>
  <li>To simulate the cross-origin call, we can access the page in a browser using the domain localhost. From the JavaScript code, we make the call using the IP address <em>127.0.0.1</em>. Even if <em>localhost</em> and <em>127.0.0.1</em> refer to the same host, the browser sees these as different strings and considers these different domains</li>
  <li><strong>Pre-flight requests</strong>
    <ul>
      <li>the browser first makes a call using the HTTP OPTIONS method to test whether the request should be allowed. We call this test request a <em>preflight request</em>. If the preflight request fails, the browser won’t attempt to honor the original request.</li>
      <li>The preflight request and the decision to make it or not are the responsibility of the browser. You don’t have to implement this logic. But it is important to understand it, so you won’t be surprised to see cross-origin calls to the backend even if you did not specify any CORS policies for specific domains.</li>
    </ul>
  </li>
</ul>

<h2 id="applying-cors-policies-using-crossorigin-annotation">Applying CORS policies using @CrossOrigin annotation</h2>

<ul>
  <li>You can place the <code>@CrossOrigin</code> annotation directly above the method that defines the endpoint and configure it using the allowed origins and methods.</li>
  <li>Allow origins: The value parameter of <code>@CrossOrigin</code> receives an array to let you define multiple origins; for example, <code>@CrossOrigin({"example.com", "example.org"})</code>.</li>
  <li>You can also set the allowed headers and methods using the <code>allowedHeaders</code> attribute and the <code>methods</code> attribute of the annotation.</li>
  <li>For both <em>origins</em> and <em>headers</em>, you can use the asterisk (<code>*</code>) to represent all headers or all origins. However, it’s always better to filter the origins and headers that you want to allow and never allow any domain to implement code that accesses your applications’ resources. By allowing all origins, you expose the application to cross-site scripting (XSS) requests, which eventually can lead to DDoS attacks</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@PostMapping</span><span class="o">(</span><span class="s">&quot;/test&quot;</span><span class="o">)</span>
</span><span class="line"><span class="nd">@ResponseBody</span>
</span><span class="line"><span class="nd">@CrossOrigin</span><span class="o">(</span><span class="s">&quot;http://localhost:8080&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">String</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">  <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Test method called&quot;</span><span class="o">);</span>
</span><span class="line">  <span class="k">return</span> <span class="s">&quot;HELLO&quot;</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>Pros
    <ul>
      <li>The advantage of using <code>@CrossOrigin</code> to specify the rules directly where the endpoints are defined is that it creates good transparency of the rules.</li>
    </ul>
  </li>
  <li>Cons
    <ul>
      <li>The disadvantage is that it might become verbose, forcing you to repeat a lot of code. It also imposes the risk that the developer might forget to add the annotation for newly implemented endpoints.</li>
    </ul>
  </li>
</ul>

<h2 id="applying-cors-using-a-corsconfigurer">Applying CORS using a CorsConfigurer</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Defining CORS configurations centralized in the configuration class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProjectConfig</span> <span class="kd">extends</span> <span class="n">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@Override</span>
</span><span class="line">  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="n">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">cors</span><span class="o">(</span><span class="n">c</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">      <span class="n">CorsConfigurationSource</span> <span class="n">source</span> <span class="o">=</span> <span class="n">request</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class="line">        <span class="n">CorsConfiguration</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CorsConfiguration</span><span class="o">();</span>
</span><span class="line">        <span class="n">config</span><span class="o">.</span><span class="na">setAllowedOrigins</span><span class="o">(</span>
</span><span class="line">            <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;example.com&quot;</span><span class="o">,</span> <span class="s">&quot;example.org&quot;</span><span class="o">));</span>
</span><span class="line">        <span class="n">config</span><span class="o">.</span><span class="na">setAllowedMethods</span><span class="o">(</span>
</span><span class="line">            <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;GET&quot;</span><span class="o">,</span> <span class="s">&quot;POST&quot;</span><span class="o">,</span> <span class="s">&quot;PUT&quot;</span><span class="o">,</span> <span class="s">&quot;DELETE&quot;</span><span class="o">));</span>
</span><span class="line">        <span class="k">return</span> <span class="n">config</span><span class="o">;</span>
</span><span class="line">      <span class="o">};</span>
</span><span class="line">      <span class="n">c</span><span class="o">.</span><span class="na">configurationSource</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
</span><span class="line">         <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">();</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="references">References</h1>

<ul>
  <li>Book - Spring Security in Action (Manning publications)</li>
</ul>

  
    <footer>
      
      
        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://fizalihsan.github.io/technology/spring-security.html" data-via="fizalihsan" data-counturl="http://fizalihsan.github.io/technology/spring-security.html" >Tweet</a>
  
  
  
</div>

      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    <section>

	<br/><br/>
	<ul>
		<h2>Technical</h2>

		<li>
			<h3>Architecture</h3>
			<a href="/technology/architecture.html">Overview</a>  |  
			<a href="/technology/coding-principles.html">Coding Principles</a> |	
			<a href="/technology/ddd.html">DDD</a>  |  
			<a href="/technology/design-principles.html">Design Principles</a>  |
			<a href="/technology/eventsourcing.html">Event Sourcing</a> |  
			<a href="/technology/lambda-architecture.html">Lambda Architecture</a>  |  
			<a href="/technology/observability.html">Observability</a>  |  
			<a href="/technology/operations.html">Operations</a> |
			<a href="/technology/patterns.html">Patterns</a>|  
			<a href="/technology/sdlc.html">SDLC</a> |  
			<a href="/technology/scalability.html">Scalability</a>  |  
			<a href="/technology/security.html">Security</a>  |  
			<a href="/technology/transaction.html">Transactions</a>
		</li>

		<li>
			<h3>BigData</h3>
			<a href="/technology/bigdata.html">Concepts</a>  |  
			<a href="/technology/distributedcomputing.html">Distributed Computing</a>  |  
			<a href="/technology/elasticsearch.html">ElasticSearch</a>  |  
			<a href="/technology/bigdata-frameworks.html">Frameworks</a>  |  
			<a href="/technology/hadoop-ecosystem.html">Hadoop Ecosystem</a>  | 
			<a href="/technology/knowledgegraph.html">Knowledge Graph</a> |
			<a href="/technology/nosql.html">NoSQL</a>  |  
			<a href="/technology/concurrency-parallelism.html">Parallel Computing</a>
		</li>

		<li>
			<h3>Cloud Computing</h3>
			<a href="/technology/cloud-computing.html">Concepts</a>  |  
			<a href="/technology/aws.html">AWS</a>  |  
			<a href="/technology/infrastructure-as-code.html">Infrastructure as Code</a>  |  
			<a href="/technology/serverless.html">Serverless</a> |
			<a href="/technology/virtualization.html">Virtualization</a>
		</li>

		<li>
			<h3>Database</h3>
			<a href="/technology/rdbms.html">Concepts</a>  |  
			<a href="/technology/db-design.html">Design</a>  |  
			<a href="/technology/db-performance.html">Performance</a>  |  
			<a href="/technology/sql.html">SQL</a>
		</li>

		<li>
			<h3>Functional Programming</h3>
			<a href="/technology/functionalprogramming.html">Concepts</a>
		</li>

		<li>
			<h3>Java</h3>
			<a href="/technology/java.html">Core Concepts</a>  |  
			<a href="/technology/java-collections.html">Collections</a>  |  
			<a href="/technology/java-concurrency.html">Concurrency</a>  |  
			<a href="/technology/java-database.html">Database</a>  |  
			<a href="/technology/java-jmx.html">JMX</a>  |  
			<a href="/technology/java-jndi.html">JNDI</a>  |  
			<a href="/technology/java-io.html">I/O</a>  |  
			<a href="/technology/java-performance.html">Performance</a>  |  
			<a href="/technology/java-testing.html">Testing</a>  |  
			<a href="/technology/java-web.html">Web</a>  |  
			<a href="/technology/java-newsletters.html">Java Specialist Newsletters</a>
		</li>

		<li>
			<h3>Languages</h3>
			<a href="/technology/groovy.html">Groovy</a>  |  
			<a href="/technology/python.html">Python</a>  |  
			<a href="/technology/scala.html">Scala</a>
		</li>

		<li>
			<h3>Integration</h3>
			<a href="/technology/soa.html">Concepts</a>  |  
			<a href="/technology/bff.html">BFF</a> |
			<a href="/technology/camel.html">Camel</a>  |  
			<a href="/technology/graphql.html">GraphQL</a>  |  
			<a href="/technology/messaging.html">Messaging</a> |  
			<a href="/technology/microservices.html">Microservices</a>   |  
			<a href="/technology/rest-services.html">REST</a>  | 
			<a href="/technology/servicemesh.html">Service Mesh</a> |
			<a href="/technology/soap-services.html">SOAP</a>  |  
			
			<a href="/technology/webservices.html">Web Services</a> |  
			<a href="/technology/xml.html">XML</a>
		</li>

		<li>
			<h3>Spring</h3>
			<a href="/technology/spring-batch.html">Batch</a>  |  
			<a href="/technology/spring.html">Core</a>  |  
			<a href="/technology/spring-mvc.html">MVC</a> |
			<a href="/technology/spring-security.html">Security</a>
		</li>

		<li>
			<h3>Web</h3>
			<a href="/technology/webconcepts.html">Concepts</a> |
			<a href="/technology/webanalytics.html">Analytics</a> |
			<a href="/technology/angular.html">Angular</a> | 
			<a href="/technology/webapp_architecture.html">Architecture</a> | 
			<a href="/technology/http.html">HTTP</a> |
			<a href="/technology/js.html">JS</a> |
			<a href="/technology/microfrontend.html">Micro-Frontend</a> |
			<a href="/technology/web_security.html">Security</a> |
			<a href="/technology/ux.html">UX</a>
		</li>

		<li>
			<h3>General Concepts</h3>
			<a href="/technology/algorithms.html">Algorithms</a>  |  
			<a href="/softskills/brain-teasers.html">Brain Teasers</a>  |  
			<a href="/technology/datastructures.html">Data Structures</a>  |  
			<a href="/technology/design-faqs.html">Design FAQs</a>  |  
			<a href="/technology/networking.html">Networking</a>  |  
			<a href="/technology/oops.html">OOPS</a>  |  
			<a href="/technology/os.html">Operating Systems</a>  |  
			<a href="/technology/vcs.html">VCS</a>
		</li>

		<h2>Non-Techninal</h2>
		<li>
			<a href="/misc/okr.html">OKR</a>
		</li>
		<li>
			<h3>Domain Knowledge</h3>
			<a href="/domain/retirement.html">Retirement</a>
		</li>

		<li>
			<h3>Soft Skills</h3>
			<a href="/softskills/presentation.html">Presentation</a>  |  
			<a href="/softskills/productivity.html">Productivity</a>  |  
			<a href="/softskills/written.html">Written Communication</a>
		</li>
	</ul>

  <!-- <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
  </ul> &#8211;>
  <!-- <ul>
    <li><a href="/datascience/statistics.html">Statistics</a></li>
    <li><a href="/datascience/r.html">R Programming</a></li>
  </ul> &#8211;>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/fizalihsan">@fizalihsan</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fizalihsan',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2022 - Mohamed Fizal Ihsan Mohamed -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
