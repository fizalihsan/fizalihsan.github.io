
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Transaction Management - KnowledgeShop</title>
  <meta name="author" content="Mohamed Fizal Ihsan Mohamed">


<meta name="description" content="Transaction Management Overview Consistency Models ACID property BASE property CAP Theorem Transaction Models Local transactions Programmatic &hellip;">
<meta name="keywords" content="big data, data science, mongodb, nosql, R, statistics">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://fizalihsan.github.io/technology/transaction.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!-- Below custom CSS is for table border styling -->
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

  <link href="" rel="alternate" title="KnowledgeShop" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
jax: ["input/TeX", "output/HTML-CSS"],
tex2jax: {
  inlineMath: [ ['$', '$'], ["\\(","\\)"] ],
  displayMath: [ ['$$', '$$'], ["\\[","\\]"] ],
  processEscapes: true,
  skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
},
messageStyle: "none",
"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript" /></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-58187831-1']);
    _gaq.push(['_setDomainName','github.io']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">KnowledgeShop</a></h1>
  
    <h2>Learn & Share</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:fizalihsan.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  


<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Transaction Management</h1>
    
  </header>
  
  <ul id="markdown-toc">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#consistency-models">Consistency Models</a>    <ul>
      <li><a href="#acid-property">ACID property</a></li>
      <li><a href="#base-property">BASE property</a></li>
      <li><a href="#cap-theorem">CAP Theorem</a></li>
    </ul>
  </li>
  <li><a href="#transaction-models">Transaction Models</a>    <ul>
      <li><a href="#local-transactions">Local transactions</a></li>
      <li><a href="#programmatic-transactions">Programmatic transactions</a></li>
      <li><a href="#declarative-transactions">Declarative transactions</a>        <ul>
          <li><a href="#transaction-attributes">Transaction Attributes</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#transaction-isolation-level">Transaction Isolation Level</a></li>
  <li><a href="#transaction-read-phenomena">Transaction Read Phenomena</a>    <ul>
      <li><a href="#dirty-read--uncommitted-read">1. Dirty Read / Uncommitted Read</a></li>
      <li><a href="#non-repeatable-read">2. Non-Repeatable Read</a></li>
      <li><a href="#phantom-read">3. Phantom Read</a></li>
    </ul>
  </li>
  <li><a href="#distributed-transaction-processing">Distributed Transaction Processing</a>    <ul>
      <li><a href="#xa-transaction-processing">XA Transaction Processing</a>        <ul>
          <li><a href="#xa-resource">XA Resource</a></li>
        </ul>
      </li>
      <li><a href="#phase-commit-protocol">2-phase commit protocol</a></li>
      <li><a href="#heuristic-exceptions">Heuristic Exceptions</a>        <ul>
          <li><a href="#heuristic-exception-types">Heuristic Exception Types</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#transaction-strategies">Transaction Strategies</a>    <ul>
      <li><a href="#api-layer-strategy">1. API Layer Strategy</a></li>
      <li><a href="#client-orchestration-strategy">2. Client Orchestration Strategy</a></li>
      <li><a href="#high-concurrency-strategy">3. High Concurrency Strategy</a></li>
      <li><a href="#high-performance-strategy">4. High Performance Strategy</a></li>
    </ul>
  </li>
  <li><a href="#open-items">Open Items</a></li>
  <li><a href="#bibliography">Bibliography</a></li>
</ul>

<h1 id="overview">Overview</h1>

<ul>
  <li>JTA (Java Transaction API)
    <ul>
      <li>is a high-level, implementation-independent, protocol-independent API that allows applications and application servers to access transactions. </li>
      <li>is an API, just like JDBC, implemented by vendors - typically by commercial servers or by open source txn managers such as JBoss Txn Service or JOTM.</li>
    </ul>
  </li>
  <li>JTS (Java Transaction Services)
    <ul>
      <li>specifies the implementation of a Transaction Manager which supports JTA and implements the Java mapping of the OMG Object Transaction Service (OTS) 1.1 specification at the level below the API. </li>
      <li>JTS propagates transactions using the Internet Inter-ORB Protocol (IIOP).</li>
    </ul>
  </li>
  <li>JTA interfaces
    <ul>
      <li><code>UserTransaction</code> Interface</li>
      <li><code>javax.transaction.UserTransaction</code> - allows to programmatically begin, commit or rollback txns, or get status.</li>
      <li><code>TransactionManager</code> Interface</li>
      <li>primarily used within the Declarative Txn Model.</li>
    </ul>
  </li>
</ul>

<h1 id="consistency-models">Consistency Models</h1>

<h2 id="acid-property">ACID property</h2>

<ul>
  <li><strong>Atomicity</strong> - means a txn must either be a commit or rollback all updates as a single unit of work.</li>
  <li><strong>Consistency</strong> - means during the course of the txn, the resource (db or EMS) will not be left in an inconsistent state.</li>
  <li><strong>Isolation</strong> - During the course of the txn, intermittent status of various participants is not visible to the external world.</li>
  <li><strong>Durability</strong> - means when the txn is committed, then it is guaranteed that the txn is complete and the db or JMS updates are permanent.</li>
</ul>

<p>ACID mean that once a transaction is complete, its data is consistent (<em>tech lingo: write consistency</em>) and stable on disk, which may involve multiple distinct memory locations.</p>

<p>Write consistency can be a wonderful thing for application developers, but it also requires sophisticated locking which is typically a heavyweight pattern for most use cases.</p>

<h2 id="base-property">BASE property</h2>

<ul>
  <li><strong>Basic Availability</strong> - The database appears to work most of the time.</li>
  <li><strong>Soft-state</strong> - Stores don’t have to be write-consistent, nor do different replicas have to be mutually consistent all the time.</li>
  <li><strong>Eventual consistency</strong> - Stores exhibit consistency at some later point (e.g., lazily at read time).</li>
</ul>

<p>A BASE datastore values availability (since that’s important for scale), but it doesn’t offer guaranteed consistency of replicated data at write time. Overall, the BASE consistency model provides a less strict assurance than ACID: data will be consistent in the future, either at read time (e.g., Riak) or it will always be consistent, but only for certain processed past snapshots (e.g., Datomic).</p>

<h2 id="cap-theorem">CAP Theorem</h2>

<p>distributed databases uses.</p>

<p>http://ivoroshilin.com/2012/12/13/brewers-cap-theorem-explained-base-versus-acid/</p>

<p><strong>Combination 1: CA</strong></p>

<ul>
  <li>What does it mean?</li>
  <li>When to use this?</li>
</ul>

<p><strong>Combination 2: CP</strong></p>

<ul>
  <li>What does it mean?</li>
  <li>When to use this?</li>
</ul>

<p><strong>Combination 3: AP</strong></p>

<ul>
  <li>What does it mean?</li>
  <li>When to use this?</li>
</ul>

<h1 id="transaction-models">Transaction Models</h1>

<h2 id="local-transactions">Local transactions</h2>

<ul>
  <li>Txn is not managed by the framework, but by the local resource manager like db or messaging provider.</li>
  <li>Developer manages connection, not the txn.</li>
  <li><strong>Pros</strong>
    <ul>
      <li>Code is simple code. All you have to do is to turn off auto commit on Connection, and commit/rollback when needed.</li>
      <li>Works well for simple applications</li>
    </ul>
  </li>
  <li><strong>Cons/limitations</strong>
    <ul>
      <li>Error-prone. Plenty of room for developers to make mistakes which could be disastrous.</li>
      <li>Works only on a single resource. Cannot co-ordinate a txn across global resources like Db and EMS.</li>
      <li>Say if the txn code is split between different DAOs, the connection needs to be explicitly passed (called as <strong><em>connection passing strategy</em></strong>) which is typically error-prone.</li>
    </ul>
  </li>
</ul>

<h2 id="programmatic-transactions">Programmatic transactions</h2>

<ul>
  <li>Leverages JTA API implementation</li>
  <li>Developer manages txn rather than the connection, using <code>javax.transaction.UserTransaction</code></li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>EJB Example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">UserTransaction</span> <span class="n">txn</span> <span class="o">=</span> <span class="n">sessionCtx</span><span class="o">.</span><span class="na">getUserTransaction</span><span class="o">();</span>
</span><span class="line"><span class="n">txn</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
</span><span class="line"><span class="k">try</span><span class="o">{</span>
</span><span class="line">    <span class="n">myDAO</span><span class="o">.</span><span class="na">updateOne</span><span class="o">(...);</span>
</span><span class="line">    <span class="n">myDAO</span><span class="o">.</span><span class="na">updateTwo</span><span class="o">(...);</span>
</span><span class="line">    <span class="n">txn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span> <span class="k">catch</span><span class="o">(...){</span>
</span><span class="line">    <span class="n">txn</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
</span><span class="line">    <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Spring Example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kn">import</span> <span class="nn">org.springframework.transaction.support.*</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="n">TransactionTemplate</span> <span class="n">transactionTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">TransactionTemplate</span><span class="o">();</span>
</span><span class="line">
</span><span class="line"><span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nf">TransactionCallback</span><span class="o">(){</span>
</span><span class="line">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">doInTransaction</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">){</span>
</span><span class="line">      <span class="k">try</span><span class="o">{</span>
</span><span class="line">          <span class="n">myDAO</span><span class="o">.</span><span class="na">updateOne</span><span class="o">();</span>
</span><span class="line">      <span class="o">}</span><span class="k">catch</span><span class="o">(...){</span>
</span><span class="line">          <span class="n">status</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class="line">          <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>In the above EJB example, txn context is propagated to the DAO. Unlike the local txn model, DAO need not manage connections/txns. All it needs to do is get connections from a pool.</li>
  <li>In the above Spring example, there is no need to explicitly invoke begin() or commit(). Also, the rollback is hinted via the txn status, and not on txn itself.</li>
  <li>Typically an instance of <code>UserTransaction</code> is obtained via JNDI look up. </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">UserTransaction</span> <span class="n">txn</span> <span class="o">=</span> <span class="o">(</span><span class="n">UserTransaction</span><span class="o">)</span><span class="k">new</span> <span class="nf">InitialContext</span><span class="o">().</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;javax.transaction.UserTransaction&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>However, the look up string name could be different for app servers. To run the code outside of a container like for unit test cases, TransactionManager interface is used as below.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>Load the txn manager factory class</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="c1">//Websphere EJB txn manager example</span>
</span><span class="line"><span class="n">Class</span> <span class="n">txnClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&quot;com.ibm.ejs.jts.jta.TransactionManagerFactory&quot;</span><span class="o">);</span>
</span><span class="line">
</span><span class="line"><span class="n">TransactionManager</span> <span class="n">mgr</span> <span class="o">=</span> <span class="o">(</span><span class="n">TransactionManager</span><span class="o">)</span><span class="n">txnClass</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;getTransactionManager&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">          <span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class="line">
</span><span class="line"><span class="c1">//Start the txn via txn manager</span>
</span><span class="line"><span class="n">mgr</span><span class="o">.</span><span class="na">begin</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>When to use?
    <ul>
      <li>client-initiated transactions</li>
      <li>Localized JTA transactions - If the process has multiple steps and if a txn is required only during a particular phase, then the only way to achieve this localized JTA txn is via programmatic model.</li>
      <li>For performance reasons.</li>
    </ul>
  </li>
  <li>Cons
    <ul>
      <li>Error-prone - since developer is handling txns, if exceptions are not handled properly in the code, it could be disastrous.</li>
      <li>Transaction Context Problem: A txn context cannot be passed from a DAO that implements programmatic txn model into another DAO implementing the same txn model. Because, when one of them invoke the other, both will try to begin a new txn on separate threads. This violates the ACID principle since failure in other thread won’t be visible to the other.</li>
    </ul>
  </li>
</ul>

<h2 id="declarative-transactions">Declarative transactions</h2>

<ul>
  <li>Framework or container manages the txn (which is why it is also called Container Managed Transactions or CMT)</li>
  <li>Txns are configured through configuration parameters. e.g., XML descriptors in EJB or bean definition file <code>ApplicationContext.xml</code> in Spring.</li>
  <li>Developer only says when to rollback. In Spring, rollback rules are specified via <code>TransactionAttributeSource</code> interceptor.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>EJB Example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Stateless</span>
</span><span class="line"><span class="nd">@TransactionManagement</span><span class="o">(</span><span class="n">TransactionManagementType</span><span class="o">.</span><span class="na">CONTAINER</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDAO</span><span class="o">{</span>
</span><span class="line">   <span class="nd">@TransactionAttribute</span><span class="o">(</span><span class="n">TransactionAttributeType</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
</span><span class="line">   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(){</span>
</span><span class="line">      <span class="k">try</span><span class="o">{</span>
</span><span class="line">          <span class="n">myDAO</span><span class="o">.</span><span class="na">updateOne</span><span class="o">(...);</span>
</span><span class="line">          <span class="n">myDAO</span><span class="o">.</span><span class="na">updateTwo</span><span class="o">(...);</span>
</span><span class="line">      <span class="o">}</span><span class="k">catch</span><span class="o">(...){</span>
</span><span class="line">          <span class="n">sessionCtx</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class="line">          <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
</span><span class="line">      <span class="o">}</span>
</span><span class="line">   <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>As in the above EJB example, developer invokes only the <code>setRollbackOnly()</code> method. At class level, we specify that it uses declarative transaction through the annotation. </li>
  <li>In Spring, developer need not call the method explicitly. Instead the rollback rules of when to rollback is specified in the <code>TransactionAttributeSource</code> interceptor. We specify that it uses declarative transaction through <code>TransactionProxyFactoryBean</code> proxy - the txn bean is wrapped with a proxy.</li>
</ul>

<h3 id="transaction-attributes">Transaction Attributes</h3>

<p>In declarative txn, we must tell the container when to begin a txn, which methods should participate in a txn, etc. There are 6 transaction attributes </p>

<ul>
  <li>Transaction Attributes
    <ul>
      <li>can be specified at method-level and bean-level. </li>
      <li>bean-level setting applies for all the methods in the class, which can be overridden.</li>
      <li>even if not specified, default attribute is applied to all the methods.</li>
    </ul>
  </li>
  <li>Spring interface <code>Synchronization</code> provides callback methods for the <code>afterBegin()</code>, <code>beforeCompletion()</code>, and <code>afterCompletion()</code> of a JTA transaction.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Attribute Value (For Spring prefix PROPAGATION_ )</th>
      <th>Txn is needed to execute the method?</th>
      <th>What if a txn is already open?</th>
      <th>What if no txn open?</th>
      <th>When to use?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>REQUIRED</td>
      <td>Yes</td>
      <td>Use it</td>
      <td>Start a new one</td>
      <td> </td>
    </tr>
    <tr>
      <td>MANDATORY</td>
      <td>Yes</td>
      <td>An open txn must always exist before invoking the method</td>
      <td>Throws exception. Never starts a new one.</td>
      <td> </td>
    </tr>
    <tr>
      <td>REQUIRESNEW</td>
      <td>Yes. Always start a new txn.</td>
      <td>Suspend existing txn, start new one and resume the previous one after completing the new one.</td>
      <td>Start a new one</td>
      <td>When an activity needs to be committed regardless of the surrounding txn. E.g. audit logging during trading operation</td>
    </tr>
    <tr>
      <td>SUPPORTS</td>
      <td>No</td>
      <td>Use it. In fact, any uncommitted change made by the surrounding txn is also visible.</td>
      <td>It works as it and doesn’t start a new txn.</td>
      <td> </td>
    </tr>
    <tr>
      <td>NOTSUPPORTED</td>
      <td>No</td>
      <td>Suspend existing txn, complete the method invocation and resume the txn.</td>
      <td> </td>
      <td>For example, invoking a stored proc containing a DDL within the context of an XA txn will throw exception. This attribute is useful in such cases.</td>
    </tr>
    <tr>
      <td>NEVER</td>
      <td>No. Never start a txn.</td>
      <td>Throws exception</td>
      <td>N/A</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h1 id="transaction-isolation-level">Transaction Isolation Level</h1>

<p>Transaction isolation is a function of db concurrency and db consistency. As we increase the level of txn isolation, we in effect lower the db concurrency but increase the db consistency. (Isolation­­­ &amp; Consistency are inversely proportional to concurrency )</p>

<ul>
  <li><strong>Data concurrency</strong> means that many users can access data at the same time.</li>
  <li>
    <p><strong>Data consistency</strong> means that each user sees a consistent view of the data, including visible changes made by the user’s own transactions and transactions of other users.</p>
  </li>
  <li><strong>1. Dirty Read / Read Uncommitted</strong>
    <ul>
      <li>Allows transactions to read non-committed updates made by other transactions.</li>
      <li>Lowest level of isolation supported by EJB &amp; Spring.</li>
    </ul>
  </li>
  <li><strong>2. Read Committed</strong>
    <ul>
      <li>Allows multiple transactions to access the same data, hiding the non-committed updates from other transactions until they are committed.</li>
      <li>This is the default isolation setting for most of the databases.</li>
    </ul>
  </li>
  <li><strong>3. Repeatable Read</strong>
    <ul>
      <li>Repeatable read is a higher isolation level, that in addition to the guarantees of the read committed level, it also guarantees that any data read cannot change, if the transaction reads the same data again, it will find the previously read data in place, unchanged, and available to read.</li>
      <li>Ensures that once a set of values are read from the db for a particular txn, that same set of values will be read every time the select statement is executed, unless the txn holding the read and write locks modifies the data.</li>
    </ul>
  </li>
  <li><strong>4. Serializable</strong>
    <ul>
      <li>serializable makes an even stronger guarantee: in addition to everything repeatable read guarantees, it also guarantees that no new data can be seen by a subsequent read</li>
      <li>Interleaving txns are stacked up so that only one txn is allowed access to data at a time.</li>
      <li>The serializable mode of transaction behavior tries to ensure that transactions run in such a way that they appear to be executed one at a time, or serially, rather than concurrently.</li>
      <li>Lowest level of isolation supported by Java.</li>
    </ul>
  </li>
</ul>

<table>
  <thead>
    <tr>
      <th>Dirty Read / Uncommitted Read</th>
      <th>Read Committed</th>
      <th>Repeatable Read</th>
      <th>Serializable</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><img src="/technology/dirty-read.png" /></td>
      <td><img src="/technology/read-committed.png" /></td>
      <td><img src="/technology/repeatable-read.png" /></td>
      <td><img src="/technology/serializable.png" /></td>
    </tr>
  </tbody>
</table>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">BEGIN</span> <span class="n">TRANSACTION</span><span class="p">;</span>
</span><span class="line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">T</span><span class="p">;</span>
</span><span class="line"><span class="n">WAITFOR</span> <span class="n">DELAY</span> <span class="s1">&#39;00:01:00&#39;</span>
</span><span class="line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">T</span><span class="p">;</span>
</span><span class="line"><span class="k">COMMIT</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That is a simple task that issue two reads from table T, with a delay of 1 minute between them.</p>

<ul>
  <li>under READ COMITTED, the second SELECT may return <strong><em>any data</em></strong>. A concurrent transaction may update the record, delete it, insert new records. The second select will always see the <strong><em>new data</em></strong>.</li>
  <li>under REPEATABLE READ, the second SELECT is guaranteed to see the rows that has seen at first select <strong><em>unchanged</em></strong>. New rows may be added by a concurrent transaction in that one minute, but the existing rows cannot be deleted nor changed.</li>
  <li>
    <p>under SERIALIZABLE, the second select is guaranteed to see <strong><em>exactly</em></strong> the same rows as the first. No row can change, nor deleted, nor new rows could be inserted by a concurrent transaction.</p>
  </li>
  <li><strong>SNAPSHOT</strong>
    <ul>
      <li>And finally, there is also the SNAPSHOT isolation level. SNAPSHOT isolation level makes the same guarantees as serializable, but not by requiring that no concurrent transaction can modify the data, but by making every reader see it’s own version of the world (it’s own ‘snapshot’). This makes it very easy to program against, very scalable as it does not block concurrent updates, but of course it has a price, and the price is extra server resource consumption.</li>
    </ul>
  </li>
</ul>

<h1 id="transaction-read-phenomena">Transaction Read Phenomena</h1>

<p>Transaction Read Phenomena</p>

<p>http://docs.oracle.com/cd/B28359_01/server.111/b28318/consist.htm</p>

<p>The ANSI/ISO SQL standard (SQL92) defines 4 levels of transaction isolation with differing degrees of impact on transaction processing throughput. These isolation levels are defined in terms of 3 phenomena that must be prevented between concurrently executing transactions.</p>

<p>The three preventable phenomena are:</p>

<h2 id="dirty-read--uncommitted-read">1. Dirty Read / Uncommitted Read</h2>

<ul>
  <li>One process (P1) modifies a row, and another process (P2) then reads that row before it is committed by P1. If P1 then rolls back the change, P2 will have read a row that was never committed and that may thus be considered to have never existed.</li>
  <li>Isolation Level: <code>READ UNCOMMITTED</code></li>
</ul>

<h2 id="non-repeatable-read">2. Non-Repeatable Read</h2>

<ul>
  <li>Process P1 reads a row. Process P2 then modifies or deletes that rows and commits the change. If P1 re-reads the row it receives the modified value or discovers the row has been deleted.</li>
  <li>Isolation Level: <code>READ COMMITTED</code></li>
</ul>

<h2 id="phantom-read">3. Phantom Read</h2>

<ul>
  <li>Process P1 reads the set of rows N that satisfy some search condition. Process P2 then executes statements that generate one or more rows that satisfy the search condition. If P1 repeats the query it obtains a different collection of rows.</li>
  <li>Phantom Vs. Non-repeatable
    <ul>
      <li>The Non-Repeatable Read is a phenomena specific to a read of a single record. When data has changed in this record, and the record is read again, the changed data is returned. This is a non-repeatable read.</li>
      <li>The Phantom Read is a phenomenon that deals with queries that return sets. The thing that’s changing in a phantom read is not the data in the records; it’s the set membership that has changed.</li>
      <li>For records that have been deleted, if a transaction reads them (or rather fails to read them) it would seem that this is both a non-repeatable read and a phantom read. But for the purposes of the ISO/ANSI standard it is in fact considered a non-repeatable read.</li>
    </ul>
  </li>
</ul>

<table>
  <tbody>
    <tr>
      <td><strong>Isolation Level</strong></td>
      <td><strong>Dirty Read</strong></td>
      <td><strong>Nonrepeatable Read</strong></td>
      <td><strong>Phantom Read</strong></td>
    </tr>
    <tr>
      <td><strong>Read Uncommitted</strong></td>
      <td>Possible</td>
      <td>Possible</td>
      <td>Possible</td>
    </tr>
    <tr>
      <td><strong>Read Committed</strong></td>
      <td>Not Possible</td>
      <td>Possible</td>
      <td>Possible</td>
    </tr>
    <tr>
      <td><strong>Repeatable Read</strong></td>
      <td>Not Possible</td>
      <td>Not Possible</td>
      <td>Possible</td>
    </tr>
    <tr>
      <td><strong>Serializable</strong></td>
      <td>Not Possible</td>
      <td>Not Possible</td>
      <td>Not Possible</td>
    </tr>
  </tbody>
</table>

<h1 id="distributed-transaction-processing">Distributed Transaction Processing</h1>

<p>Distributed txn is a txn that spans over 1 or more resources. It could be between 2 different dbs, or 2 different messaging channels, or db and a messaging queue/topic.</p>

<h2 id="xa-transaction-processing">XA Transaction Processing</h2>

<p><img class="right" src="/technology/xa-transaction.png" /></p>

<ul>
  <li>The X/Open XA Interface is a bi-directional system-level interface that forms the communication bridge between a transaction manager and 1 or more resource managers. </li>
  <li>The Transaction Manager manages the lifecycle of a txn, and co-ordinates resources. In JTA, txn manager is abstracted through the <code>javax.transaction.TransactionManager</code> interface and implemented through the underlying transaction service.</li>
  <li>The Resource Manager controls and manages the actual resource participating in the txn like db or JMS queue.</li>
  <li>
    <p>XA txn should only be used when a transaction needs to be coordinated between multiple resources, i.e., databases, queues or topics. </p>
  </li>
  <li>What is the relation between XA and JTA?</li>
</ul>

<p>???</p>

<h3 id="xa-resource">XA Resource</h3>

<ul>
  <li>Without XA, messages sent to a topic/queue are typically read by receivers immediately. With XA, the message in the queue would not be released until the txn is committed.</li>
  <li>To perform a XA txn between multiple resources, each participating resource should be an XA resource. (Some vendors support a feature where 1 resource could be a non-XA resource. )</li>
</ul>

<h2 id="phase-commit-protocol">2-phase commit protocol</h2>

<ul>
  <li>Mechanism used by XA to coordinate multiple resources during a global transaction. </li>
  <li>A txn manager coordinates txns between resource managers using a two-phase commit protocol. </li>
  <li>The two-phase commit protocol provides the ACID properties of transactions across multiple resources. </li>
  <li>In phase 1, 
    <ul>
      <li>the transaction manager tells each resource to “prepare” to commit; that is, to perform all operations for a commit and be ready either to make the changes permanent or to undo all changes. </li>
      <li>Each resource manager responds back with READY, READ_ONLY or NOT_READY. </li>
    </ul>
  </li>
  <li>In phase 2, if all resource managers respond back with READY, the transaction manager tells all resource managers to commit their changes; otherwise, it tells them all to roll back and indicates transaction failure to the application. Participants that respond with a READ_ONLY are removed from the 2nd phase. </li>
  <li>2-phase commit is possible due to the bi-directional communication capabilities of the XA interface.</li>
  <li><strong>Last Participant Support</strong> / <strong>Last Resource Commit</strong>
    <ul>
      <li>Some commercial containers allow this feature where an non-XA resource to participate in a global txn. The non-XA resource participates only in the phase 1 of the txn.</li>
    </ul>
  </li>
</ul>

<table>
  <thead>
    <tr>
      <th>2PC Commit Scenario</th>
      <th>2PC Rollback Scenario</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><img src="/technology/2pc-commit.png" /></td>
      <td><img src="/technology/2pc-rollback.png" /></td>
    </tr>
  </tbody>
</table>

<h2 id="heuristic-exceptions">Heuristic Exceptions</h2>

<p>During the 2-phase commit process a Resource Manager may use heuristic decision making and either commit or rollback its work independent of the Txn Mgr. Heuristic decision making is a process that involves making intelligent choices based on various internal and external factors. When a Resource Manager does this it is reported back to the client through Heuristic Exception.</p>

<p>They only occur under XA during the 2-phase commit process, specifically after a participant has responded in phase 1. The most common reason for this is a timeout condition between phase 1 and 2. When communication is lost or delayed, the resource managers might make a decision to commit or rollback its work in order to free up resources.</p>

<h3 id="heuristic-exception-types">Heuristic Exception Types</h3>

<p>The 3 JTA Heuristic exceptions in JTA are</p>

<ul>
  <li><code>HeuristicRollbackException</code> - between phase 1 and 2, if <em>all the resource mgrs</em> decides to rollback the txn, then upon entering phase 2 of the commit request this exception is thrown back to the caller.</li>
  <li><code>HeuristicMixedException</code> - same as above, but this is thrown if <em>one of the resource mgrs</em> decides to rollback.</li>
  <li><code>HeuristicCommitException</code></li>
</ul>

<h1 id="transaction-strategies">Transaction Strategies</h1>

<p>Two golden rules apply to all of the transaction strategies :</p>

<ul>
  <li>The method that starts the transaction is designated as the transaction owner</li>
  <li>Only the transaction owner can roll back the transaction</li>
</ul>

<h2 id="api-layer-strategy">1. API Layer Strategy</h2>

<p><img class="right" src="/technology/api-txn-strategy.png" /></p>

<ul>
  <li>Transaction Owner: API Layer - this is where the begin, commit and rollback of a txn occurs</li>
  <li>When to apply this?
    <ul>
      <li>apps with coarse-grained API layer</li>
      <li>apps with multiple client channels like webservice client, desktop client, web client, etc.</li>
    </ul>
  </li>
  <li>Rules for implementing this strategy
    <ul>
      <li>only public methods in the API layer should have txn logic</li>
      <li>all public write methods are marked with REQUIRED txn attribute</li>
      <li>all public read method are marked with SUPPORTS</li>
      <li>all public write methods should handle checked exceptions with a rollback logic</li>
    </ul>
  </li>
  <li>Limitations/Restrictions
    <ul>
      <li>When a public write method calls another public write method in a txn, and if an exception occurs, the rollback logic could potentially be handled by the 2nd method instead of the txn owner.</li>
      <li>Clients cannot make a multiple calls to API layer as a single unit of work.</li>
      <li>Extra attention needed if the same public method is called by clients that act as a txn owner and clients does not start a txn. (see <a href="http://www.ibm.com/developerworks/java/library/j-ts3/index.html#restrictions">IBM article</a> for more details)</li>
    </ul>
  </li>
</ul>

<h2 id="client-orchestration-strategy">2. Client Orchestration Strategy</h2>

<ul>
  <li>Transaction Owner: Client Layer. Though both client &amp; API layer contains the txn logic, only the client layer begins, commits and rolls back the txn. API layer has only  txn attributes marked on the methods.</li>
  <li>When to apply this?
    <ul>
      <li>apps with complex and fine-grained API layer</li>
      <li>cannot use with clients that cannot propagate txn to API layer, e.g., JMS clients, web service clients, etc.</li>
    </ul>
  </li>
  <li>Rules for implementing this strategy
    <ul>
      <li>only client &amp; API layer contains the txn logic. Client layer is the txn owner</li>
      <li>typically with this strategy, programmatic model is used in client. The exception to this rule is if the client business delegate in the client layer controlling the transaction scope is managed as a Spring bean by the Spring Framework. In this case, you can use the declarative transaction model provided by Spring.</li>
      <li>all public write methods in API layer are marked as MANDATORY - no rollback logic in them</li>
      <li>all public read methods in API layer are marked as SUPPORT.</li>
      <li>If the client layer is making remote calls to the API layer, the client layer must use a protocol and transaction manager that supports the propagation of a transaction context (such as RMI-IIOP).</li>
    </ul>
  </li>
  <li>Limitations/Restrictions
    <ul>
      <li>Client layer must be able to start a txn and propagate it to the API layer. This is not possible with JMS client or web service client</li>
    </ul>
  </li>
</ul>

<h2 id="high-concurrency-strategy">3. High Concurrency Strategy</h2>

<p>???</p>

<h2 id="high-performance-strategy">4. High Performance Strategy</h2>

<p>???</p>

<h1 id="open-items">Open Items</h1>

<ul>
  <li>MVCC, Optimistic locking</li>
  <li>Paxos consensus protocol</li>
</ul>

<h1 id="bibliography">Bibliography</h1>

<ul>
  <li>Books
    <ul>
      <li>Java Transaction Design Strategies - Mark Richards</li>
      <li>Java Transaction Processing: Design and Implementation - Mark Little, Jon Maron, Greg Pavlik</li>
      <li>Principles of Transaction Processing - Philip A. Bernstein, Eric Newcomer</li>
    </ul>
  </li>
  <li>Websites
    <ul>
      <li><a href="http://www.ibm.com/developerworks/views/java/libraryview.jsp?site_id=1&amp;contentarea_by=Java&amp;sort_by=Date&amp;sort_order=1&amp;start=1&amp;end=6&amp;topic_by=&amp;product_by=&amp;type_by=All%20Types&amp;show_abstract=true&amp;search_by=transaction%20strategies:&amp;industry_by=&amp;series_title_by=">IBM - Txn Mgmt Series - Mark Richards</a></li>
      <li><a href="http://static.springsource.org/spring/docs/3.0.x/reference/transaction.html">Spring Txn Mgmt</a></li>
      <li>http://www.jboss.org/jbosstm/resources/fundamentals.html</li>
      <li>http://www.pjug.org/jta-j2ee-pjug-2003-07-22.ppt</li>
      <li><a href="http://www.subbu.org/articles/transactions/NutsAndBoltsOfTP.html">Nuts And Bolts Of TP</a></li>
      <li><a href="http://www.javaworld.com/article/2077963/open-source-tools/distributed-transactions-in-spring--with-and-without-xa.html">Distributed transactions in Spring, with and without XA</a></li>
    </ul>
  </li>
</ul>

  
    <footer>
      
      
        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://fizalihsan.github.io/technology/transaction.html" data-via="fizalihsan" data-counturl="http://fizalihsan.github.io/technology/transaction.html" >Tweet</a>
  
  
  
</div>

      
    </footer>
  
</article>

</div>

<aside class="sidebar">
  
    <section>

	<br/><br/>
	<ul>
		<h2>Technical</h2>

		<li>
			<h3>Architecture</h3>
			<a href="/technology/architecture.html">Overview</a>  |  <a href="/technology/cloud-computing.html">Cloud Computing</a>  |  <a href="/technology/coding-principles.html">Coding Principles</a>  |  <a href="/technology/concurrency-parallelism.html">Concurrency & Parallelism</a>  |  <a href="/technology/design-principles.html">Design Principles</a>  |  <a href="/technology/logging-and-monitoring.html">Logging &amp; Monitoring</a>  |  <a href="/technology/patterns.html">Patterns</a>  |  <a href="/technology/sdlc.html">SDLC</a>  |  <a href="/technology/security.html">Security</a>  |  <a href="/technology/transaction.html">Transactions</a>
		</li>
		
		<li>
			<h3>BigData</h3>
			<a href="/technology/bigdata.html">Concepts</a>  |  <a href="/technology/distributedcomputing.html">Distributed Computing</a>  |  <a href="/technology/elasticsearch.html">ElasticSearch</a>  |  <a href="/technology/nosql.html">NoSQL</a>
		</li>

		<li>
			<h3>Database</h3>
			<a href="/technology/rdbms.html">Concepts</a>  |  <a href="/technology/db-design.html">Design</a>  |  <a href="/technology/db-performance.html">Performance</a>  |  <a href="/technology/rdbms-products.html">RDBMS Products</a>
		</li>

		<li>
			<h3>Functional Programming</h3>
			<a href="/technology/functionalprogramming.html">Concepts</a>  |  <a href="/technology/groovy.html">Groovy</a>  |  <a href="/technology/scala.html">Scala</a>
		</li>

		<li>
			<h3>Java</h3>
			<a href="/technology/java.html">Core Concepts</a>  |  <a href="/technology/java-collections.html">Collections</a>  |  <a href="/technology/java-concurrency.html">Concurrency</a>  |  <a href="/technology/java-database.html">Database</a>  |  <a href="/technology/java-jmx.html">JMX</a>  |  <a href="/technology/java-jndi.html">JNDI</a>  |  <a href="/technology/java-io.html">I/O</a>  |  <a href="/technology/java-performance.html">Performance</a>  |  <a href="/technology/spring.html">Spring</a>  |  <a href="/technology/java-testing.html">Testing</a>  |  <a href="/technology/java-web.html">Web</a>  |  <a href="/technology/java-newsletters.html">Java Specialist Newsletters</a>
		</li>

		<li>
			<h3>SOA</h3>
			<a href="/technology/soa.html">Concepts</a>  |  <a href="/technology/messaging.html">Messaging</a>  |  <a href="/technology/webservices.html">Web Services</a>   |  <a href="/technology/rest-services.html">REST</a>  |  <a href="/technology/soap-services.html">SOAP</a> |  <a href="/technology/xml.html">XML</a>
		</li>

		<li>
			<h3>Spring</h3>
			<a href="/technology/spring.html">Core</a>  |  <a href="/technology/spring-mvc.html">MVC</a>
		</li>

		<li>
			<h3>Web Programming</h3>
			<a href="/technology/webconcepts.html">Concepts</a> | <a href="/technology/js-ecosystem.html">JS Ecosystem</a>
		</li>

		<li>
			<h3>General Concepts</h3>
			<a href="/technology/algorithms.html">Algorithms</a>  |  <a href="/technology/datastructures.html">Data Structures</a>  |  <a href="/technology/oops.html">OOPS</a>  |  <a href="/technology/os.html">Operating Systems</a>  |  <a href="/technology/vcs.html">VCS</a>  |  <a href="/technology/coding_bibliography.html">Coding Bibliography</a>
		</li>

		<h2>Non-Techninal</h2>

		<li>
			<h3>Data Science</h3>

			<a href="/datascience/datascience.html">Overview</a>  |  <a href="/datascience/statistics.html">Statistics</a>  |  <a href="/datascience/r.html">R</a>
		</li>

		<li>
			<h3>Domain Knowledge</h3>
			<a href="/domain/retirement.html">Retirement</a>
		</li>

		<li>
			<h3>Soft Skills</h3>
			<a href="/softskills/presentation.html">Presentation</a>  |  <a href="/softskills/productivity.html">Productivity</a>  |  <a href="/softskills/written.html">Written Communication</a>
		</li>
	</ul>

  <!-- <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
  </ul> &#8211;>
  <!-- <ul>
    <li><a href="/datascience/statistics.html">Statistics</a></li>
    <li><a href="/datascience/r.html">R Programming</a></li>
  </ul> &#8211;>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/fizalihsan">@fizalihsan</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fizalihsan',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Mohamed Fizal Ihsan Mohamed -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
